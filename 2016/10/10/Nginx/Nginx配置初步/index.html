<!DOCTYPE HTML>
<html>

<head>
	<!-- hexo-inject:begin --><!-- hexo-inject:end --><link rel="bookmark" type="image/x-icon" href="/bitbug_favicon_64s.ico" />
	<link rel="shortcut icon" href="/bitbug_favicon_64s.ico">
	
	    <title>
    Cultoy
    </title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="/css/mic_main.css" />
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" />
    <link rel="stylesheet" href="/css/dropdownMenu.css" />
    <meta name="keywords" content="maywzh" />
    
    <noscript>
        <link rel="stylesheet" href="/css/noscript.css" />
    </noscript>
    <style type="text/css">
        body:before {
          content: ' ';
          position: fixed;
          top: 0;
          background: url('https://i.loli.net/2020/03/02/mYeD6WLp3kOy1qw.png') center 0 no-repeat;
          right: 0;
          bottom: 0;
          left: 0;
          background-size: cover; 
        }
    </style>

	    
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script async type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


    <script src="https://cdn.jsdelivr.net/gh/jquery/jquery@1.11.3/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ajlkn/jquery.scrollex@0.2.1/jquery.scrollex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/maywzh/jquery.scrolly@0.0.1/dist/jquery.scrolly.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ajlkn/skel@3.0.1/dist/skel.min.js"></script>
    <script src="/js/util.js"></script>
    <script src="/js/main.js"></script>
	
<meta name="generator" content="Hexo 5.1.1"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

<!-- Layouts -->



<!--  代码渲染  -->
<link rel="stylesheet" href="/css/prism_okaidia.css" />
<link rel="stylesheet" href="/css/typo.css" />
<!-- 文章页 -->

<body class="is-loading">
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><!-- Wrapper 外包 s-->
    <div id="wrapper" class="fade-in">
        <!-- Intro 头部显示 s -->
        <!-- Intro 头部显示 e -->
        <!-- Header 头部logo start -->
        <header id="header">
    <a href="/" class="logo">MAYWZH</a>
</header>
        <!-- Nav 导航条 start -->
        <nav id="nav" class="special">
	<ul class="menu links">
		<!-- Homepage  主页  -->
		<li>
			<a href="/" rel="nofollow">Home</a>
		</li>
		<!-- categories_name  分类   -->
		
		<li class="active">
			<a href="#s1">Category</a>
			<ul class="submenu">
				<li>
					<a class="category-link" href="/categories/DevOps/">DevOps</a></li><li><a class="category-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a></li><li><a class="category-link" href="/categories/%E5%88%B7%E9%A2%98/">刷题</a></li><li><a class="category-link" href="/categories/%E5%9D%91/">坑</a></li><li><a class="category-link" href="/categories/%E5%AF%86%E7%A0%81%E5%AD%A6/">密码学</a></li><li><a class="category-link" href="/categories/%E5%B7%A5%E5%85%B7/">工具</a></li><li><a class="category-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a></li><li><a class="category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></li><li><a class="category-link" href="/categories/%E6%96%B9%E6%B3%95%E8%AE%BA/">方法论</a></li><li><a class="category-link" href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">机器学习</a></li><li><a class="category-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a></li><li><a class="category-link" href="/categories/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/">系统设计</a></li><li><a class="category-link" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></li><li><a class="category-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/">计算机组成原理</a></li><li><a class="category-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a>
			</ul>
		</li>
		
		<!-- archives  归档   -->
		
		<li class="active">
			<a href="#s1">Archive</a>
			<ul class="submenu">
				<li>
					<a class="archive-link" href="/archives/2020/">2020</a></li><li><a class="archive-link" href="/archives/2019/">2019</a></li><li><a class="archive-link" href="/archives/2018/">2018</a></li><li><a class="archive-link" href="/archives/2017/">2017</a></li><li><a class="archive-link" href="/archives/2016/">2016</a></li><li><a class="archive-link" href="/archives/2015/">2015</a>
			</ul>
		</li>
		

		<!-- Pages 自定义   -->
		
		<li>
			<a href="/tags/" title="Tags">
				Tags
			</a>
		</li>
		
		<li>
			<a href="/about/" title="About">
				About
			</a>
		</li>
		


	</ul>
	<!-- icons 图标   -->
	<ul class="icons">
		
		<li>
			<a title="search" href="https://io.maywzh.com" target="_blank" rel="noopener">
				<i class="icon fa fa-search"></i>
			</a>
		</li>
		
		
		<li>
			<a title="twitter" href="https://twitter.com/maywzh" target="_blank" rel="noopener">
				<i class="icon fa fa-twitter"></i>
			</a>
		</li>
		
		<li>
			<a title="github" href="https://github.com/maywzh" target="_blank" rel="noopener">
				<i class="icon fa fa-github"></i>
			</a>
		</li>
		
	</ul>
</nav>

        <div id="main">
            <div class="post_page_title_img"
                style="height: 25rem;background-image: url(https://i.loli.net/2020/09/10/LrbA5CJ3DulWSTU.png);background-position: center; background-repeat:no-repeat; background-size:cover;-moz-background-size:cover;overflow:hidden;">
                <a href="#" style="padding: 4rem 4rem 2rem 4rem ;">
                    <h2>Nginx 配置初步</h2>
                </a>
            </div>
            <!-- Post -->
            <div class="typo" style="padding: 3rem;">
                <p>Nginx 是一款轻量级的 Web 服务器、反向代理服务器，由于它的内存占用少，启动极快，高并发能力强，在互联网项目中广泛应用。这里实践一下 nginx 的配置</p>
<a id="more"></a>
<h2><span id="安装">安装 </span></h2><p> 下载必要组件</p>
<ul>
<li><p>nginx 下载地址</p>
<pre class="line-numbers language-none"><code class="language-none">http:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;download.html<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>pcre 库下载地址，nginx 需要</p>
<pre class="line-numbers language-none"><code class="language-none">http:&#x2F;&#x2F;sourceforge.net&#x2F;projects&#x2F;pcre&#x2F;files&#x2F;pcre&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>zlib 下载地址，nginx 需要</p>
<pre class="line-numbers language-none"><code class="language-none">http:&#x2F;&#x2F;www.zlib.net&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>openssl 下载地址，nginx 需要</p>
<pre class="line-numbers language-none"><code class="language-none">https:&#x2F;&#x2F;github.com&#x2F;openssl&#x2F;openssl<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p>在同级目录下, 解压安装 zlib、openssl、pcre</p>
<p>进入 nginx 目录，进行配置安装</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./configure <span class="token punctuation">\</span>
 --prefix<span class="token operator">=</span>/usr/local/nginx <span class="token punctuation">\</span>
 --with-http_ssl_module <span class="token punctuation">\</span>
 --with-http_flv_module <span class="token punctuation">\</span>
 --with-http_stub_status_module <span class="token punctuation">\</span>
 --with-http_gzip_static_module <span class="token punctuation">\</span>
 --with-pcre<span class="token operator">=</span><span class="token punctuation">..</span>/pcre-8.39 <span class="token punctuation">\</span>
 --with-zlib<span class="token operator">=</span><span class="token punctuation">..</span>/zlib-1.2.8 <span class="token punctuation">\</span> 
 --with-openssl<span class="token operator">=</span><span class="token punctuation">..</span>/openssl-master<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>下面可直接复制粘贴</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./configure --prefix<span class="token operator">=</span>/usr/local/nginx --with-http_ssl_module --with-http_flv_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre<span class="token operator">=</span><span class="token punctuation">..</span>/pcre-8.39 --with-zlib<span class="token operator">=</span><span class="token punctuation">..</span>/zlib-1.2.8 --with-openssl<span class="token operator">=</span><span class="token punctuation">..</span>/openssl-master<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>编译安装</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Nginx 会被安装在 /usr/local/nginx 目录下（也可以使用参数—prefix= 指定自己需要的位置）， 安装成功后 /usr/local/nginx 目录下有四个子目录分别是：conf、html、logs、sbin 。 其中 Nginx 的配置文件存放于 conf/nginx.conf， bin 文件是位于 sbin 目录下的 nginx 文件。 确保系统的 80 端口没被其他程序占用，运行 sbin/nginx 命令来启动 Nginx，</p>
<p>启动 nginx</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> /usr/local/nginx/sbin/nginx
    <span class="token comment">#netstat -ano|grep 80</span>
        tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span>.0.0:80              <span class="token number">0.0</span>.0.0:*               LISTEN      关闭 <span class="token punctuation">(</span><span class="token number">0.00</span>/0/0<span class="token punctuation">)</span>
        unix  <span class="token number">17</span>     <span class="token punctuation">[</span> <span class="token punctuation">]</span>         数据报                <span class="token number">10801</span>    /dev/log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>打开浏览器访问此机器的 IP，如果浏览器出现 Welcome to nginx! 则表示 Nginx 已经安装并运行成功</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 检查配置文件是否正确</span>
/usr/local/sbin/nginx -t 
<span class="token comment"># 可以看到编译选项</span>
/usr/local/sbin/nginx -V
<span class="token comment"># 重启 Nginx</span>
<span class="token function">sudo</span> /usr/local/sbin/nginx -s reload
<span class="token comment"># 关闭 Nginx</span>
<span class="token function">sudo</span> /usr/local/sbin/nginx -s stop
<span class="token comment"># 优雅停止服务</span>
<span class="token function">sudo</span> /usr/local/sbin/nginx -s quit
<span class="token function">kill</span> -s SIGQUIT pid_master
<span class="token function">kill</span> -s SIGWINCH pid_master<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2><span id="配置">配置</span></h2><p>nginx.conf 配置文件, 基本就分为以下几块：</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx">main
<span class="token keyword">events</span>   <span class="token punctuation">&#123;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">http</span>        <span class="token punctuation">&#123;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">upstream</span> myproject <span class="token punctuation">&#123;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">server</span>  <span class="token punctuation">&#123;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">location</span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">server</span>  <span class="token punctuation">&#123;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">location</span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>nginx 配置文件主要分为六个区域：</p>
<ul>
<li>main(全局设置)</li>
<li>events(nginx 工作模式)</li>
<li>http(http 设置)</li>
<li>sever(主机设置)</li>
<li>location(URL 匹配)</li>
<li>upstream(负载均衡服务器设置)</li>
</ul>
<p>下面依次来看下具体内容</p>
<ul>
<li>main 模块</li>
</ul>
<p>下面时一个 main 区域，他是一个全局的设置：</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">user</span> nobody nobody<span class="token punctuation">;</span>
<span class="token keyword">worker_processes</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">error_log</span>  <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>error<span class="token punctuation">.</span>log  notice<span class="token punctuation">;</span>
<span class="token keyword">pid</span>        <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>var<span class="token operator">/</span>run<span class="token operator">/</span>nginx<span class="token operator">/</span>nginx<span class="token punctuation">.</span><span class="token keyword">pid</span><span class="token punctuation">;</span>
<span class="token keyword">worker_rlimit_nofile</span> <span class="token number">1024</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>user 来指定 Nginx Worker 进程运行用户以及用户组，默认由 nobody 账号运行。</p>
<p>worker_processes 来指定了 Nginx 要开启的子进程数。每个 Nginx 进程平均耗费 10M~12M 内存。根据经验，一般指定 1 个进程就足够了，如果是多核 CPU，建议指定和 CPU 的数量一样的进程数即可。我这里写 2，那么就会开启 2 个子进程，总共 3 个进程。</p>
<p>error_log 用来定义全局错误日志文件。日志输出级别有 debug、info、notice、warn、error、crit 可供选择，其中，debug 输出日志最为最详细，而 crit 输出日志最少。</p>
<p>pid 用来指定进程 id 的存储文件位置。</p>
<p>worker_rlimit_nofile 用于指定一个 nginx 进程可以打开的最多文件描述符数目，这里是 65535，需要使用命令“ulimit -n 65535”来设置。</p>
<ul>
<li>events 模块</li>
</ul>
<p>events 模块来用指定 nginx 的工作模式和工作模式及连接数上限，一般是这样：</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">events</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">use</span> epoll<span class="token punctuation">;</span> <span class="token comment">#Linux 平台</span>
    <span class="token keyword">worker_connections</span>  <span class="token number">1024</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>use 用来指定 Nginx 的工作模式。Nginx 支持的工作模式有 select、poll、kqueue、epoll、rtsig 和 /dev/poll。其中 select 和 poll 都是标准的工作模式，kqueue 和 epoll 是高效的工作模式，不同的是 epoll 用在 Linux 平台上，而 kqueue 用在 BSD 系统中, 对于 Linux 系统，epoll 工作模式是首选。</p>
<p>worker_connections 用于定义 Nginx 每个进程的最大连接数，即接收前端的最大请求数，默认是 1024。最大客户端连接数由 worker_processes 和 worker_connections 决定，即 Max_clients=worker_processes<em>worker_connections，在作为反向代理时，Max_clients 变为：Max_clients = worker_processes </em> worker_connections/4。 进程的最大连接数受 Linux 系统进程的最大打开文件数限制，在执行操作系统命令“ulimit -n 65536”后 worker_connections 的设置才能生效。</p>
<ul>
<li>http 模块</li>
</ul>
<p>http 模块可以说是最核心的模块了，它负责 HTTP 服务器相关属性的配置，它里面的 server 和 upstream 子模块，至关重要，等到反向代理和负载均衡以及虚拟目录等会仔细说。</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">http</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">include</span>       mime<span class="token punctuation">.</span><span class="token keyword">types</span><span class="token punctuation">;</span>
    <span class="token keyword">default_type</span>  application<span class="token operator">/</span>octet<span class="token operator">-</span>stream<span class="token punctuation">;</span>
    <span class="token keyword">log_format</span>  main  <span class="token string">'$remote_addr - $remote_user [$time_local]"$request" '</span>
                      <span class="token string">'$status $body_bytes_sent"$http_referer" '</span>
                      <span class="token string">'"$http_user_agent" "$http_x_forwarded_for"'</span><span class="token punctuation">;</span>
    <span class="token keyword">access_log</span>  <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>access<span class="token punctuation">.</span>log  main<span class="token punctuation">;</span>
    <span class="token keyword">sendfile</span>        on<span class="token punctuation">;</span>
    <span class="token keyword">tcp_nopush</span>      on<span class="token punctuation">;</span>
    <span class="token keyword">tcp_nodelay</span>     on<span class="token punctuation">;</span>
    <span class="token keyword">keepalive_timeout</span>  <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token comment">#gzip  on;</span>
    <span class="token keyword">upstream</span> myproject <span class="token punctuation">&#123;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">server</span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>下面详细介绍下这段代码中每个配置选项的含义。</p>
<p>include 来用设定文件的 mime 类型, 类型在配置文件目录下的 mime.type 文件定义，来告诉 nginx 来识别文件类型。</p>
<p>default_type 设定了默认的类型为二进制流，也就是当文件类型未定义时使用这种方式，例如在没有配置 asp 的 locate 环境时，Nginx 是不予解析的，此时，用浏览器访问 asp 文件就会出现下载了。</p>
<p>log_format 用于设置日志的格式，和记录哪些参数，这里设置为 main，刚好用于 access_log 来纪录这种类型。</p>
<p>main 的类型日志如下：也可以增删部分参数。</p>
<pre class="line-numbers language-none"><code class="language-none">127.0.0.1 - - [21&#x2F;Apr&#x2F;2015:18:09:54 +0800] &quot;GET &#x2F;index.php HTTP&#x2F;1.1&quot; 200 87151 &quot;-&quot; &quot;Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10_10_2) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;41.0.2272.76 Safari&#x2F;537.36&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>access_log</p>
<p>用来纪录每次的访问日志的文件地址，后面的 main 是日志的格式样式，对应于 log_format 的 main。</p>
<p>sendfile 参数用于开启高效文件传输模式。将 tcp_nopush 和 tcp_nodelay 两个指令设置为 on 用于防止网络阻塞。</p>
<p>keepalive_timeout 设置客户端连接保持活动的超时时间。在超过这个时间之后，服务器会关闭该连接。</p>
<ul>
<li>server 模块</li>
</ul>
<p>sever 模块是 http 的子模块，它用来定一个虚拟主机，我们先讲最基本的配置，这些在后面再讲。</p>
<p>我们看一下一个简单的 server 是如何做的？</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">server</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">listen</span>       <span class="token number">8080</span><span class="token punctuation">;</span>
        <span class="token keyword">server_name</span>  localhost <span class="token number">192.168</span><span class="token number">.12</span><span class="token number">.10</span> www<span class="token punctuation">.</span>yangyi<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
        <span class="token comment"># 全局定义，如果都是这一个目录，这样定义最简单。</span>
        <span class="token keyword">root</span>   <span class="token operator">/</span>Users<span class="token operator">/</span>yangyi<span class="token operator">/</span>www<span class="token punctuation">;</span>
        <span class="token keyword">index</span>  <span class="token keyword">index</span><span class="token punctuation">.</span>php <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span> 
        <span class="token keyword">charset</span> utf<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token keyword">access_log</span>  usr<span class="token operator">/</span>local<span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>host<span class="token punctuation">.</span>access<span class="token punctuation">.</span>log  main<span class="token punctuation">;</span>
        aerror_log  usr<span class="token operator">/</span>local<span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>host<span class="token punctuation">.</span>error<span class="token punctuation">.</span>log  error<span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>server 标志定义虚拟主机开始。</p>
<p>listen 用于指定虚拟主机的服务端口。</p>
<p>server_name 用来指定 IP 地址或者域名，多个域名之间用空格分开。</p>
<p>root 表示在这整个 server 虚拟主机内，全部的 root web 根目录。注意要和 locate {}下面定义的区分开来。</p>
<p>index 全局定义访问的默认首页地址。注意要和 locate {}下面定义的区分开来。</p>
<p>charset 用于设置网页的默认编码格式。</p>
<p>access_log 用来指定此虚拟主机的访问日志存放路径，最后的 main 用于指定访问日志的输出格式。</p>
<ul>
<li>location 模块</li>
</ul>
<p>location 模块是 nginx 中用的最多的，也是最重要的模块了，什么负载均衡啊、反向代理啊、虚拟域名啊都与它相关。慢慢来讲：</p>
<p>location 根据它字面意思就知道是来定位的，定位 URL，解析 URL，所以，它也提供了强大的正则匹配功能，也支持条件判断匹配，用户可以通过 location 指令实现 Nginx 对动、静态网页进行过滤处理。像我们的 php 环境搭建就是用到了它。</p>
<p>我们先来看这个，设定默认首页和虚拟机目录。</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">root</span>   <span class="token operator">/</span>Users<span class="token operator">/</span>yangyi<span class="token operator">/</span>www<span class="token punctuation">;</span>
            <span class="token keyword">index</span>  <span class="token keyword">index</span><span class="token punctuation">.</span>php <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>location / 表示匹配访问根目录。</p>
<p>root 指令用于指定访问根目录时，虚拟主机的 web 目录，这个目录可以是相对路径（相对路径是相对于 nginx 的安装目录）。也可以是绝对路径。</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token comment"># 反向代理配置</span>
<span class="token keyword">location</span> <span class="token operator">/</span>itcast<span class="token operator">/</span> <span class="token punctuation">&#123;</span>
           <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">12345</span><span class="token punctuation">;</span>
           <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>real<span class="token operator">-</span>ip <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
           <span class="token keyword">proxy_set_header</span> Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>


<span class="token comment"># 采用 uwsgi 方式</span>
<span class="token keyword">location</span> <span class="token operator">/</span>python<span class="token operator">/</span> <span class="token punctuation">&#123;</span>
           <span class="token keyword">include</span> uwsgi_params<span class="token punctuation">;</span>
           uwsgi_pass <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">33333</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>



  <span class="token comment"># 访问 nginx 本机目录的文件</span>
  <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">root</span>   <span class="token operator">/</span>home<span class="token operator">/</span>itcast<span class="token operator">/</span>xwp<span class="token operator">/</span>itcast<span class="token operator">/</span><span class="token punctuation">;</span>
          <span class="token keyword">index</span>  <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

  <span class="token keyword">location</span>  <span class="token operator">/</span>static<span class="token operator">/</span> <span class="token punctuation">&#123;</span>
           <span class="token keyword">alias</span> <span class="token operator">/</span>var<span class="token operator">/</span>static<span class="token operator">/</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>upstram 模块</li>
</ul>
<p>upstream 模块负债负载均衡模块，通过一个简单的调度算法来实现客户端 IP 到后端服务器的负载均衡。我先学习怎么用，具体的使用实例以后再说。</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">upstream</span> test<span class="token punctuation">.</span>com<span class="token punctuation">&#123;</span>
    <span class="token keyword">ip_hash</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> <span class="token number">192.168</span><span class="token number">.123</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">80</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> <span class="token number">192.168</span><span class="token number">.123</span><span class="token number">.2</span><span class="token punctuation">:</span><span class="token number">80</span> down<span class="token punctuation">;</span>
    <span class="token keyword">server</span> <span class="token number">192.168</span><span class="token number">.123</span><span class="token number">.3</span><span class="token punctuation">:</span><span class="token number">8080</span>  max_fails<span class="token operator">=</span><span class="token number">3</span>  fail_timeout<span class="token operator">=</span><span class="token number">20</span>s<span class="token punctuation">;</span>
    <span class="token keyword">server</span> <span class="token number">192.168</span><span class="token number">.123</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">8080</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在上面的例子中，通过 upstream 指令指定了一个负载均衡器的名称 test.com。这个名称可以任意指定，在后面需要的地方直接调用即可。</p>
<p>里面是 ip_hash 这是其中的一种负载均衡调度算法。</p>
<p>Nginx 的负载均衡模块目前支持 4 种调度算法:</p>
<ul>
<li>weight 轮询（默认）。每个请求按时间顺序逐一分配到不同的后端服务器，如果后端某台服务器宕机，故障系统被自动剔除，使用户访问不受影响。weight。指定轮询权值，weight 值越大，分配到的访问机率越高，主要用于后端每个服务器性能不均的情况下。</li>
<li>ip_hash。每个请求按访问 IP 的 hash 结果分配，这样来自同一个 IP 的访客固定访问一个后端服务器，有效解决了动态网页存在的 session 共享问题。</li>
<li>fair。比上面两个更加智能的负载均衡算法。此种算法可以依据页面大小和加载时间长短智能地进行负载均衡，也就是根据后端服务器的响应时间来分配请求，响应时间短的优先分配。Nginx 本身是不支持 fair 的，如果需要使用这种调度算法，必须下载 Nginx 的 upstream_fair 模块。</li>
<li>url_hash。按访问 url 的 hash 结果来分配请求，使每个 url 定向到同一个后端服务器，可以进一步提高后端缓存服务器的效率。Nginx 本身是不支持 url_hash 的，如果需要使用这种调度算法，必须安装 Nginx 的 hash 软件包。</li>
</ul>
<p>在 HTTP Upstream 模块中，可以通过 server 指令指定后端服务器的 IP 地址和端口，同时还可以设定每个后端服务器在负载均衡调度中的状态。常用的状态有：</p>
<p>down，表示当前的 server 暂时不参与负载均衡。</p>
<p>backup，预留的备份机器。当其他所有的非 backup 机器出现故障或者忙的时候，才会请求 backup 机器，因此这台机器的压力最轻。</p>
<p>max_fails，允许请求失败的次数，默认为 1。当超过最大次数时，返回 proxy_next_upstream 模块定义的错误。</p>
<p>fail_timeout，在经历了 max_fails 次失败后，暂停服务的时间。max_fails 可以和 fail_timeout 一起使用。</p>
<p>注意 当负载调度算法为 ip_hash 时，后端服务器在负载均衡调度中的状态不能是 weight 和 backup。</p>
<p>备注： nginx 的 worker_rlimit_nofile 达到上限时，再有客户端链接报 502 错误. 用了 log_format 指令设置了日志格式之后，需要用 access_log 指令指定日志文件的存放路径.</p>
<h2><span id="反向代理">反向代理 </span></h2><p> 正向代理，也就是传说中的代理, 他的工作原理就像一个跳板，简单的说，我是一个用户，我访问不了某网站，但是我能访问一个代理服务器，这个代理服务器呢，他能访问那个我不能访问的网站，于是我先连上代理服务器，告诉他我需要那个无法访问网站的内容，代理服务器去取回来，然后返回给我。 从网站的角度，只在代理服务器来取内容的时候有一次记录，有时候并不知道是用户的请求，也隐藏了用户的资料，这取决于代理告不告诉网站。结论就是，正向代理 是一个位于客户端和原始服务器 (origin server) 之间的服务器，为了从原始服务器取得内容，客户端向代理发送一个请求并指定目标(原始服务器)，然后代理向原始服务器转交请求并将获得的内容返回给客户端。客户端必须要进行一些特别的设置才能使用正向代理。</p>
<p>反向代理（Reverse Proxy）方式是指以代理服务器来接受 internet 上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给 internet 上请求连接的客户端，此时代理服务器对外就表现为一个反向代理服务器。</p>
<p>从用途上来讲：</p>
<ul>
<li>正向代理的典型用途是为在防火墙内的局域网客户端提供访问 Internet 的途径。</li>
<li>正向代理还可以使用缓冲特性减少网络使用率。反向代理的典型用途是将防火墙后面的服务器提供给 Internet 用户访问。</li>
<li>反向代理还可以为后端的多台服务器提供负载平衡，或为后端较慢的服务器提供缓冲服务。</li>
<li>反向代理还可以启用高级 URL 策略和管理技术，从而使处于不同 web 服务器系统的 web 页面同时存在于同一个 URL 空间下。</li>
</ul>
<h3><span id="反向代理服务器的基本配置">反向代理服务器的基本配置</span></h3><ol>
<li><p>proxy_pass</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">proxy_pass</span> URL<span class="token punctuation">;</span>
配置块 <span class="token keyword">location</span> <span class="token keyword">if</span>
此配置将当前请求代理到 URL 参数指定的服务器上<span class="token punctuation">,</span>URL 可以是主机名或者 IP 地址加 PORT 的形式
<span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token punctuation">;</span>
也可以结合负载均衡实用 <span class="token operator">&lt;</span> 负载均衡会说明这种情况<span class="token operator">></span>
也可以吧 <span class="token keyword">HTTP</span> 转换成<span class="token keyword">HTTPS</span>
<span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">;</span>
默认情况反向代理不转发请求中的 Host 头部 <span class="token punctuation">,</span> 如果需呀设置抓发头部
    则 <span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>proxy_method</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">proxy_method</span> method_name<span class="token punctuation">;</span>
配置块 <span class="token keyword">http</span> <span class="token keyword">server</span> <span class="token keyword">location</span>
此配置项表示转发时的协议方法名<span class="token punctuation">:</span>
    <span class="token keyword">proxy_method</span> POST<span class="token punctuation">;</span>
那么客户端发来的 GET 请求在转发时方法改为 POST<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>proxy_hide_header</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">proxy_hide_header</span> header1<span class="token punctuation">;</span>
配置块 <span class="token keyword">http</span> <span class="token keyword">server</span> <span class="token keyword">location</span><span class="token punctuation">;</span>
Nginx 会将上游服务器的响应转发给客户端 <span class="token punctuation">,</span> 但默认不转发 <span class="token keyword">HTTP</span> 头部字段<span class="token punctuation">(</span>Date <span class="token keyword">Server</span> X<span class="token operator">-</span>Pad X<span class="token operator">-</span>Accel<span class="token operator">-</span><span class="token operator">*</span> <span class="token punctuation">)</span>
使用 <span class="token keyword">proxy_hide_header</span> 可以指定任意头部不能被转发
<span class="token keyword">proxy_hide_header</span> Cache<span class="token operator">-</span>Control<span class="token punctuation">;</span>
<span class="token keyword">proxy_hide_header</span> MicrosoftOfficeWebServer<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>proxy_pass_header</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">proxy_pass_header</span> header1<span class="token punctuation">;</span>
配置块 <span class="token keyword">http</span> <span class="token keyword">server</span> <span class="token keyword">location</span>
功能与 <span class="token keyword">proxy_hide_header</span>相反 <span class="token punctuation">,</span> 是设置哪些头部允许转发<span class="token punctuation">.</span>
<span class="token keyword">proxy_pass_header</span> X<span class="token operator">-</span>Accel<span class="token operator">-</span>Redirect<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>proxy_pass_request_body</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">proxy_pass_request_body</span> off<span class="token operator">|</span>on<span class="token punctuation">;</span>
默认 on
配置块 <span class="token keyword">http</span> <span class="token keyword">server</span> <span class="token keyword">location</span><span class="token punctuation">;</span>
确定上游服务器是否向上游服务器转发 <span class="token keyword">HTTP</span> 包体<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>proxy_pass_request_header</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx">proxy_pass_request_header on <span class="token operator">|</span> off<span class="token punctuation">;</span>
默认 on
配置块 <span class="token keyword">http</span> <span class="token keyword">server</span> <span class="token keyword">location</span>
确定是否转发 <span class="token keyword">HTTP</span> 头部<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>proxy_redirect</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">proxy_redirect</span> <span class="token punctuation">[</span>default <span class="token operator">|</span> off <span class="token operator">|</span>redirect <span class="token operator">|</span>replacement<span class="token punctuation">]</span>
默认 default
配置块 <span class="token keyword">http</span> <span class="token keyword">server</span> <span class="token keyword">location</span>
当上游服务响应时重定向或刷新 <span class="token punctuation">(</span><span class="token keyword">HTTP</span> <span class="token number">301</span> <span class="token number">302</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">proxy_redirect</span> 可以重设 <span class="token keyword">HTTP</span> 头部的 <span class="token keyword">location</span> 或 refresh 字段
   
<span class="token keyword">proxy_redirect</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>locahost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>two<span class="token operator">/</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>frontend<span class="token operator">/</span>one<span class="token operator">/</span><span class="token punctuation">;</span>
上游响应 <span class="token number">302</span><span class="token punctuation">,</span><span class="token keyword">location</span> 是 URI 是<span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>locahost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>two<span class="token operator">/</span>some<span class="token operator">/</span>uri<span class="token operator">/</span>
那是实际转发给客户端的是 <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>frontend<span class="token operator">/</span>one<span class="token operator">/</span>some<span class="token operator">/</span>uri<span class="token operator">/</span><span class="token punctuation">;</span>
可以使用前面提到的 ngx_http_core_module 模块提供的变量 
<span class="token keyword">proxy_redirect</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>locahost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>two<span class="token operator">/</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token variable">$host</span><span class="token punctuation">:</span>server_port<span class="token operator">/</span><span class="token punctuation">;</span>
可以省略 replacement 参数的主机名部分 <span class="token punctuation">,</span> 这时候用虚拟主机名填充
<span class="token keyword">proxy_redirect</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>locahost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>two<span class="token operator">/</span> <span class="token operator">/</span>one<span class="token operator">/</span><span class="token punctuation">;</span>
   
使用 off 参数的时候 <span class="token punctuation">,</span> 将使 <span class="token keyword">location</span> 和 refresh 的字段维持不变
<span class="token keyword">proxy_redirect</span> off<span class="token punctuation">;</span>
   
如果使用的 <span class="token keyword">proxy_redirect</span> default<span class="token punctuation">;</span>
下面两种配置是等效的
    <span class="token keyword">location</span> <span class="token operator">/</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token keyword">upstream</span><span class="token punctuation">:</span>port<span class="token operator">/</span>two<span class="token operator">/</span><span class="token punctuation">;</span>
        <span class="token keyword">proxy_redirect</span> default<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">location</span> <span class="token operator">/</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token keyword">upstream</span><span class="token punctuation">:</span>port<span class="token operator">/</span>two<span class="token operator">/</span><span class="token punctuation">;</span>
        <span class="token keyword">proxy_redirect</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token keyword">upstream</span><span class="token punctuation">:</span>port<span class="token operator">/</span>two<span class="token operator">/</span> <span class="token operator">/</span>one<span class="token operator">/</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>proxy_next_upstream</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx">    <span class="token keyword">proxy_next_upstream</span> <span class="token punctuation">[</span>error <span class="token operator">|</span><span class="token keyword">timeout</span> <span class="token operator">|</span>invalid_header <span class="token operator">|</span>http_500 <span class="token operator">|</span>http_502<span class="token operator">~</span><span class="token number">504</span> <span class="token operator">|</span>http_404 <span class="token operator">|</span> off<span class="token punctuation">]</span>
    默认 <span class="token keyword">proxy_next_upstream</span> error <span class="token keyword">timeout</span><span class="token punctuation">;</span>
    配置块 <span class="token keyword">http</span> <span class="token keyword">server</span> <span class="token keyword">location</span>

    此配置表示上游一台服务器转发请求出现错误时 <span class="token punctuation">,</span> 继续换一套服务器处理这个请求
    其参数用来说明在那些情况下继续选择下一台上游服务器转发请求<span class="token punctuation">.</span>
    error 向上游发起连接 发送请求 读取响应时出错
    <span class="token keyword">timeout</span> 发送请求或读取响应时出错
    invalid_header 上游服务器发送的响应时不合法
    http_500 上游响应<span class="token number">500</span>
    http_502 上游响应<span class="token number">502</span>
    http_503 上游响应<span class="token number">503</span>
    http_504 上游响应<span class="token number">504</span>
    http_404 上游响应<span class="token number">404</span>
    off      关闭 <span class="token keyword">proxy_next_upstream</span> 功能 只要一出错就选择另外一台上游再次出发
Nginx 反向代理模块中还提供很多配置 <span class="token punctuation">,</span> 如设置连接的超时时间 <span class="token punctuation">,</span> 临时文件如何存储 <span class="token punctuation">,</span> 如何缓存上游服务器响应等功能<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
<p>可以通过阅读 ngx_http_proxy_module 了解更多详细情况</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token comment">#sudo vim /usr/local/nginx/conf/nginx.conf </span>

<span class="token keyword">server</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">listen</span>       <span class="token number">80</span><span class="token punctuation">;</span>
    <span class="token keyword">server_name</span>  localhost<span class="token punctuation">;</span>
    <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">&#123;</span>
    <span class="token comment"># 保证代理机器能访问到 下面的机器并装有 nginx  在主机号为 100 的机器上有响应网页</span>
    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.100</span><span class="token punctuation">;</span>
    <span class="token keyword">root</span>   html<span class="token punctuation">;</span>
    <span class="token keyword">index</span>  <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
sudo <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>sbin<span class="token operator">/</span>nginx <span class="token operator">-</span>s reload<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>加一些判断条件 获取到 对方请求的主机 防止别人代理到自己的主机上</p>
<h2><span id="负载均衡">负载均衡 </span></h2><p> 负载均衡是由多台服务器以对称的方式组成一个服务器集合，每台服务器都具有等价的地位，都可以单独对外提供服务而无须其他服务器的辅助。通过某种负载分担技术，将外部发送来的请求按照事先设定分配算法分配到对称结构中的某一台服务器上，而接收到请求的服务器独立地回应客户的请求。</p>
<p>均衡负载能够平均分配客户请求到服务器列阵，籍此提供快速获取重要数据，解决大量并发访问服务问题。</p>
<ol>
<li><p>upstream 块</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">upstream</span> name <span class="token punctuation">&#123;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">&#125;</span>
配置块 <span class="token keyword">http</span>
<span class="token keyword">upstream</span>块定义一个上游服务器的集群 <span class="token punctuation">,</span> 便于反向代理中的 <span class="token keyword">proxy_pass</span> 使用

<span class="token keyword">upstream</span> mynet<span class="token punctuation">&#123;</span>
    <span class="token keyword">server</span> www<span class="token punctuation">.</span>wopai1<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
    <span class="token keyword">server</span> www<span class="token punctuation">.</span>wopai2<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
    <span class="token keyword">server</span> www<span class="token punctuation">.</span>wopai3<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">server</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">location</span> <span class="token operator">/</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>mynet<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>server</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">server</span> name <span class="token punctuation">[</span>paramenters<span class="token punctuation">]</span>
配置块<span class="token keyword">upstream</span>
<span class="token keyword">server</span>配置项指定了一台上游服务器的名字 <span class="token punctuation">,</span> 可以是域名 IP 地址端口 UNIX 句柄
weight<span class="token operator">=</span> number<span class="token punctuation">;</span>设置向这台服务器转发的权重 <span class="token punctuation">,</span> 默认为<span class="token number">1</span>
max_fails<span class="token operator">=</span>number<span class="token punctuation">;</span>该选项域 fail_timeout 配合使用
        指在 fail_timeout 时间段内如果转发上游失败超过 number 次就认为当前的 fail_timeout 时间内
        这台服务器不可用<span class="token punctuation">,</span>max_fails 默认为<span class="token number">1</span> 如果设置为<span class="token number">0</span> 表示不检查失败次数
fail_timeout<span class="token operator">=</span>time<span class="token punctuation">;</span> fail_timeout 表示该时间内转发多少次失败后就认为上游不可用 <span class="token punctuation">.</span> 默认<span class="token number">10</span>s
down    表示上游服务器永久下线 <span class="token punctuation">,</span> 只能在 <span class="token keyword">ip_hash</span> 配置时才有效
backup  在 <span class="token keyword">ip_hash</span> 配置时无效 <span class="token punctuation">.</span> 只有所有非备份机都失败 <span class="token punctuation">,</span> 才向上游备份服务器转发请求<span class="token punctuation">.</span>
<span class="token keyword">upstream</span> mynet<span class="token punctuation">&#123;</span>
    <span class="token keyword">server</span> www<span class="token punctuation">.</span>wopai1<span class="token punctuation">.</span>com weight<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> www<span class="token punctuation">.</span>wopai2<span class="token punctuation">.</span>com<span class="token punctuation">:</span><span class="token number">8081</span> max_fails<span class="token operator">=</span><span class="token number">3</span> fail_timeout<span class="token operator">=</span><span class="token number">300</span>s<span class="token punctuation">;</span>
    <span class="token keyword">server</span> www<span class="token punctuation">.</span>wopai2<span class="token punctuation">.</span>com down<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>ip_hash</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx">配置块 <span class="token keyword">upstream</span>
希望来自某一个用户的请求始终落在固定的一台服务器上进行处理<span class="token punctuation">.</span>
根据客户端的 IP 散列计算出一个 key<span class="token punctuation">,</span>将 key 按照 <span class="token keyword">upstream</span> 集群中的上游服务器进行取模 <span class="token punctuation">,</span> 求得的值对应的主机接收转发请求<span class="token punctuation">.</span>
<span class="token keyword">ip_hash</span>不可以与 weight 同时使用
如果 <span class="token keyword">upstream</span> 配置中有一台服务器暂时不可用 <span class="token punctuation">,</span> 不能直接删除该配置 <span class="token punctuation">,</span> 而应该使用 down 标识<span class="token punctuation">.</span>
<span class="token keyword">upstream</span> mynet<span class="token punctuation">&#123;</span>
    <span class="token keyword">ip_hash</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> www<span class="token punctuation">.</span>wowpai1<span class="token punctuation">.</span>top<span class="token punctuation">;</span>
    <span class="token keyword">server</span> www<span class="token punctuation">.</span>wowpai2<span class="token punctuation">.</span>top<span class="token punctuation">;</span>  
    <span class="token keyword">server</span> www<span class="token punctuation">.</span>wowpai3<span class="token punctuation">.</span>top down<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
<p>例子, 服务器负载均衡基本配置,nginx 中可以进行负载均衡的相关设置:</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">upstream</span> my<span class="token punctuation">.</span>net<span class="token punctuation">&#123;</span>    <span class="token comment">#my.net 是自定义的命名 在 server 结构中引用即可</span>

<span class="token comment"># 代理服务器为 两台机器 192.168.22.136 192.168.22.147 做负载均衡操作 </span>
<span class="token comment"># 两台机器上 可以跑 apache 负载功能更为强大的网页相关任务</span>

<span class="token comment">#max_fails 表示尝试出错最大次数 即可认为该服务器 在 fail_timeout 时间内不可用</span>
<span class="token comment"># server servername:port   servername 可以写主机名 或者点分式 IP</span>
<span class="token keyword">server</span> <span class="token number">192.168</span><span class="token number">.22</span><span class="token number">.136</span><span class="token punctuation">:</span><span class="token number">80</span> max_fails<span class="token operator">=</span><span class="token number">1</span> fail_timeout<span class="token operator">=</span><span class="token number">300</span>s<span class="token punctuation">;</span>
<span class="token keyword">server</span> <span class="token number">192.168</span><span class="token number">.22</span><span class="token number">.147</span><span class="token punctuation">:</span><span class="token number">80</span> max_fails<span class="token operator">=</span><span class="token number">1</span> fail_timeout<span class="token operator">=</span><span class="token number">300</span>s<span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>


<span class="token keyword">server</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">listen</span>       <span class="token number">80</span><span class="token punctuation">;</span>
<span class="token keyword">server_name</span>  localhost<span class="token punctuation">;</span> 
<span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">#upstream 块名</span>
    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>my<span class="token punctuation">.</span>net<span class="token punctuation">;</span>
    <span class="token keyword">root</span>   html<span class="token punctuation">;</span>
    <span class="token keyword">index</span>  <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>动手开始配置才能慢慢上手 nginx 配置和使用。</p>

            </div>
            <!-- Post Comments -->
            
        </div>
        <!-- Copyright 版权 start -->
        <div id="copyright">
    <ul>
        <li>&copy;Powered By <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/" style="border-bottom: none;">hexo</a></li>
        <li>Theme: <a target="_blank" rel="noopener" href="http://miccall.tech " style="border-bottom: none;">miccall</a></li>
        <!-- <li><a href="">鄂ICP备2020015912号-1</a></li> -->
    </ul>
    
    <span id="busuanzi_container_site_pv"> 2020 </span>
    
</div>
    </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>





</html>