<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

<meta name="author" content="maywzh">


<meta name="subtitle" content="0x01 MAYSTORY">


<meta name="description" content="Namasday.">


<meta name="keywords" content="Tech Blogs">


<title>(转载) 阿里 Redis 开发规范笔记 | 0x01 MAYSTORY </title>


    
    <link rel="icon" href="/bitbug_favicon_128s.ico">
    

    
    
    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    
    
    
    
    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    
    
    
    
    
    
    
    
    
<meta name="generator" content="Hexo 5.1.1"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">梅故事壹</a> | <a
                    href="/">0x01 MAYSTORY</a></div>
            <div class="menu navbar-right">
                
                <a class="menu-item" target="_blank" rel="noopener" href="https://blog.maywzh.com">Blog</a>
                
                <a class="menu-item" target="_blank" rel="noopener" href="https://tech.maywzh.com">Tech</a>
                
                <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">梅故事壹</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                <a class="menu-item" target="_blank" rel="noopener" href="https://blog.maywzh.com">Blog</a>
                
                <a class="menu-item" target="_blank" rel="noopener" href="https://tech.maywzh.com">Tech</a>
                
                <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if (toggleMenu.classList.contains("active")) {
            toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        } else {
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">(转载) 阿里 Redis 开发规范笔记</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">maywzh</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">January 8, 2017&nbsp;&nbsp;14:18:48</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <p>本文主要介绍在使用阿里云 Redis 的开发规范，从下面几个方面进行说明。</p>
<ul>
<li>键值设计</li>
<li>命令使用</li>
<li>客户端使用</li>
<li>相关工具</li>
</ul>
<p>通过本文的介绍可以减少使用 Redis 过程带来的问题。</p>
<a id="more"></a>
<h2 id="键值设计"><a href="#键值设计" class="headerlink" title="键值设计"></a>键值设计</h2><h3 id="key-名设计"><a href="#key-名设计" class="headerlink" title="key 名设计"></a>key 名设计</h3><h4 id="可读性和可管理性"><a href="#可读性和可管理性" class="headerlink" title="可读性和可管理性"></a>可读性和可管理性</h4><p>以业务名 (或数据库名) 为前缀 (防止 key 冲突)，用冒号分隔，比如业务名：表名:id</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ugc:video:<span class="number">1</span></span><br></pre></td></tr></table></figure>
<h4 id="简洁性"><a href="#简洁性" class="headerlink" title="简洁性"></a>简洁性</h4><p>保证语义的前提下，控制 key 的长度，当 key 较多时，内存占用也不容忽视，例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user:&#123;uid&#125;:friends:messages:&#123;mid&#125; 简化为 u:&#123;uid&#125;:fr:m:&#123;mid&#125;。</span><br></pre></td></tr></table></figure>
<h4 id="不要包含特殊字符"><a href="#不要包含特殊字符" class="headerlink" title="不要包含特殊字符"></a>不要包含特殊字符</h4><p>反例：包含空格、换行、单双引号以及其他转义字符</p>
<h3 id="value-设计"><a href="#value-设计" class="headerlink" title="value 设计"></a>value 设计</h3><h4 id="拒绝-bigkey"><a href="#拒绝-bigkey" class="headerlink" title="拒绝 bigkey"></a>拒绝 bigkey</h4><p>防止网卡流量、慢查询，string 类型控制在 10KB 以内，hash、list、set、zset 元素个数不要超过 5000。反例：一个包含 200 万个元素的 list。非字符串的 bigkey，不要使用 del 删除，使用 hscan、sscan、zscan 方式渐进式删除，同时要注意防止 bigkey 过期时间自动删除问题 (例如一个 200 万的 zset 设置 1 小时过期，会触发 del 操作，造成阻塞，而且该操作不会不出现在慢查询中 (latency 可查))，查找方法和删除方法</p>
<h4 id="选择适合的数据类型"><a href="#选择适合的数据类型" class="headerlink" title="选择适合的数据类型"></a>选择适合的数据类型</h4><p>例如：实体类型 (要合理控制和使用数据结构内存编码优化配置，例如 ziplist，但也要注意节省内存和性能之间的平衡)</p>
<p>反例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set user:<span class="number">1</span>:name tom</span><br><span class="line">set user:<span class="number">1</span>:age <span class="number">19</span></span><br><span class="line">set user:<span class="number">1</span>:favor football</span><br></pre></td></tr></table></figure>
<p>正例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hmset user:<span class="number">1</span> name tom age <span class="number">19</span> favor football</span><br></pre></td></tr></table></figure>
<h4 id="控制-key-的生命周期"><a href="#控制-key-的生命周期" class="headerlink" title="控制 key 的生命周期"></a>控制 key 的生命周期</h4><p>redis 不是垃圾桶，建议使用 expire 设置过期时间 (条件允许可以打散过期时间，防止集中过期)，不过期的数据重点关注 idletime。</p>
<h2 id="命令使用"><a href="#命令使用" class="headerlink" title="命令使用"></a>命令使用</h2><h3 id="O-N-命令关注-N-的数量"><a href="#O-N-命令关注-N-的数量" class="headerlink" title="O (N) 命令关注 N 的数量"></a>O (N) 命令关注 N 的数量</h3><p>例如 hgetall、lrange、smembers、zrange、sinter 等并非不能使用，但是需要明确 N 的值。有遍历的需求可以使用 hscan、sscan、zscan 代替。</p>
<h3 id="禁用命令"><a href="#禁用命令" class="headerlink" title="禁用命令"></a>禁用命令</h3><p>禁止线上使用 keys、flushall、flushdb 等，通过 redis 的 rename 机制禁掉命令，或者使用 scan 的方式渐进式处理。</p>
<h3 id="合理使用-select"><a href="#合理使用-select" class="headerlink" title="合理使用 select*"></a>合理使用 select*</h3><p>redis 的多数据库较弱，使用数字进行区分，很多客户端支持较差，同时多业务用多数据库实际还是单线程处理，会有干扰。</p>
<h3 id="使用批量操作提高效率"><a href="#使用批量操作提高效率" class="headerlink" title="使用批量操作提高效率"></a>使用批量操作提高效率</h3><ul>
<li>原生命令：例如 mget、mset。</li>
<li>非原生命令：可以使用 pipeline 提高效率。</li>
</ul>
<p>但要注意控制一次批量操作的元素个数 (例如 500 以内，实际也和元素字节数有关)。</p>
<p>注意两者不同：</p>
<ul>
<li>原生是原子操作，pipeline 是非原子操作。</li>
<li>pipeline 可以打包不同的命令，原生做不到</li>
<li>pipeline 需要客户端和服务端同时支持。</li>
</ul>
<h3 id="不建议过多使用-Redis-事务功能"><a href="#不建议过多使用-Redis-事务功能" class="headerlink" title="不建议过多使用 Redis 事务功能"></a>不建议过多使用 Redis 事务功能</h3><p>Redis 的事务功能较弱 (不支持回滚)，而且集群版本 (自研和官方) 要求一次事务操作的 key 必须在一个 slot 上 (可以使用 hashtag 功能解决)</p>
<h3 id="Redis-集群版本在使用-Lua-上有特殊要求"><a href="#Redis-集群版本在使用-Lua-上有特殊要求" class="headerlink" title="Redis 集群版本在使用 Lua 上有特殊要求"></a>Redis 集群版本在使用 Lua 上有特殊要求</h3><p>1、所有 key 都应该由 KEYS 数组来传递，redis.call/pcall 里面调用的 redis 命令，key 的位置，必须是 KEYS array, 否则直接返回 error，”-ERR bad lua script for redis cluster, all the keys that the script uses should be passed using the KEYS arrayrn”2、所有 key，必须在 1 个 slot 上，否则直接返回 error, “-ERR eval/evalsha command keys must in same slotrn”</p>
<h3 id="monitor-命令"><a href="#monitor-命令" class="headerlink" title="monitor 命令"></a>monitor 命令</h3><p>必要情况下使用 monitor 命令时，要注意不要长时间使用。</p>
<h2 id="客户端使用"><a href="#客户端使用" class="headerlink" title="客户端使用"></a>客户端使用</h2><h3 id="避免多个应用使用一个-Redis-实例"><a href="#避免多个应用使用一个-Redis-实例" class="headerlink" title="避免多个应用使用一个 Redis 实例"></a>避免多个应用使用一个 Redis 实例</h3><p>不相干的业务拆分，公共数据做服务化。</p>
<h3 id="使用连接池"><a href="#使用连接池" class="headerlink" title="使用连接池"></a>使用连接池</h3><p>可以有效控制连接，同时提高效率，标准使用方式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> 执行命令如下：</span><br><span class="line">Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    jedis = jedisPool.getResource ();</span><br><span class="line"> <span class="comment">// 具体的命令 </span></span><br><span class="line">    jedis.executeCommand ()</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    logger.error (<span class="string">&quot;op key &#123;&#125; error: &quot;</span> + e.getMessage (), key, e);</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"> <span class="comment">// 注意这里不是关闭连接，在 JedisPool 模式下，Jedis 会被归还给资源池。</span></span><br><span class="line"> <span class="keyword">if</span> (jedis != <span class="keyword">null</span>)</span><br><span class="line">        jedis.close ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="熔断功能"><a href="#熔断功能" class="headerlink" title="熔断功能"></a>熔断功能</h3><p>高并发下建议客户端添加熔断功能 (例如 netflix hystrix)</p>
<h3 id="合理的加密"><a href="#合理的加密" class="headerlink" title="合理的加密"></a>合理的加密</h3><p>设置合理的密码，如有必要可以使用 SSL 加密访问（阿里云 Redis 支持）</p>
<h3 id="淘汰策略"><a href="#淘汰策略" class="headerlink" title="淘汰策略"></a>淘汰策略</h3><p>根据自身业务类型，选好 maxmemory-policy (最大内存淘汰策略)，设置好过期时间。默认策略是 volatile-lru，即超过最大内存后，在过期键中使用 lru 算法进行 key 的剔除，保证不过期数据不被删除，但是可能会出现 OOM 问题。</p>
<p>其他策略如下：</p>
<ul>
<li>allkeys-lru：根据 LRU 算法删除键，不管数据有没有设置超时属性，直到腾出足够空间为止。</li>
<li>allkeys-random：随机删除所有键，直到腾出足够空间为止。</li>
<li>volatile-random: 随机删除过期键，直到腾出足够空间为止。</li>
<li>volatile-ttl：根据键值对象的 ttl 属性，删除最近将要过期数据。如果没有，回退到 noeviction 策略。</li>
<li>noeviction：不会剔除任何数据，拒绝所有写入操作并返回客户端错误信息 “(error) OOM command not allowed when used memory”，此时 Redis 只响应读操作。</li>
</ul>
<h2 id="相关工具"><a href="#相关工具" class="headerlink" title="相关工具"></a>相关工具</h2><h3 id="数据同步"><a href="#数据同步" class="headerlink" title="数据同步"></a>数据同步</h3><p>redis 间数据同步可以使用：redis-port</p>
<h3 id="big-key-搜索"><a href="#big-key-搜索" class="headerlink" title="big key 搜索"></a>big key 搜索</h3><p>redis 大 key 搜索工具</p>
<h3 id="热点-key-寻找"><a href="#热点-key-寻找" class="headerlink" title="热点 key 寻找"></a>热点 key 寻找</h3><p>内部实现使用 monitor，所以建议短时间使用 facebook 的 redis-faina 阿里云 Redis 已经在内核层面解决热点 key 问题</p>
<h2 id="删除-bigkey"><a href="#删除-bigkey" class="headerlink" title="删除 bigkey"></a>删除 bigkey</h2><ul>
<li>下面操作可以使用 pipeline 加速。</li>
<li>redis 4.0 已经支持 key 的异步删除，欢迎使用。</li>
</ul>
<h3 id="Hash-删除-hscan-hdel"><a href="#Hash-删除-hscan-hdel" class="headerlink" title="Hash 删除: hscan + hdel"></a>Hash 删除: hscan + hdel</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delBigHash</span><span class="params">(String host, <span class="keyword">int</span> port, String password, String bigHashKey)</span> </span>&#123;</span><br><span class="line"> Jedis jedis = <span class="keyword">new</span> Jedis (host, port);</span><br><span class="line"> <span class="keyword">if</span> (password != <span class="keyword">null</span> &amp;&amp; !<span class="string">&quot;&quot;</span>.equals (password)) &#123;</span><br><span class="line">        jedis.auth (password);</span><br><span class="line">    &#125;</span><br><span class="line"> ScanParams scanParams = <span class="keyword">new</span> ScanParams ().count (<span class="number">100</span>);</span><br><span class="line"> String cursor = <span class="string">&quot;0&quot;</span>;</span><br><span class="line"> <span class="keyword">do</span> &#123;</span><br><span class="line"> ScanResult&lt;Entry&lt;String, String&gt;&gt; scanResult = jedis.hscan (bigHashKey, cursor, scanParams);</span><br><span class="line"> List&lt;Entry&lt;String, String&gt;&gt; entryList = scanResult.getResult ();</span><br><span class="line"> <span class="keyword">if</span> (entryList != <span class="keyword">null</span> &amp;&amp; !entryList.isEmpty ()) &#123;</span><br><span class="line"> <span class="keyword">for</span> (Entry&lt;String, String&gt; entry : entryList) &#123;</span><br><span class="line">                jedis.hdel (bigHashKey, entry.getKey ());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cursor = scanResult.getStringCursor ();</span><br><span class="line">    &#125; <span class="keyword">while</span> (!<span class="string">&quot;0&quot;</span>.equals (cursor));</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 删除 bigkey</span></span><br><span class="line">    jedis.del (bigHashKey);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h3 id="List-删除-ltrim"><a href="#List-删除-ltrim" class="headerlink" title="List 删除: ltrim"></a>List 删除: ltrim</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delBigList</span><span class="params">(String host, <span class="keyword">int</span> port, String password, String bigListKey)</span> </span>&#123;</span><br><span class="line"> Jedis jedis = <span class="keyword">new</span> Jedis (host, port);</span><br><span class="line"> <span class="keyword">if</span> (password != <span class="keyword">null</span> &amp;&amp; !<span class="string">&quot;&quot;</span>.equals (password)) &#123;</span><br><span class="line">        jedis.auth (password);</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="keyword">long</span> llen = jedis.llen (bigListKey);</span><br><span class="line"> <span class="keyword">int</span> counter = <span class="number">0</span>;</span><br><span class="line"> <span class="keyword">int</span> left = <span class="number">100</span>;</span><br><span class="line"> <span class="keyword">while</span> (counter &lt; llen) &#123;</span><br><span class="line"> <span class="comment">// 每次从左侧截掉 100 个 </span></span><br><span class="line">        jedis.ltrim (bigListKey, left, llen);</span><br><span class="line">        counter += left;</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="comment">// 最终删除 key</span></span><br><span class="line">    jedis.del (bigListKey);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h3 id="Set-删除-sscan-srem"><a href="#Set-删除-sscan-srem" class="headerlink" title="Set 删除: sscan + srem"></a>Set 删除: sscan + srem</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delBigSet</span><span class="params">(String host, <span class="keyword">int</span> port, String password, String bigSetKey)</span> </span>&#123;</span><br><span class="line"> Jedis jedis = <span class="keyword">new</span> Jedis (host, port);</span><br><span class="line"> <span class="keyword">if</span> (password != <span class="keyword">null</span> &amp;&amp; !<span class="string">&quot;&quot;</span>.equals (password)) &#123;</span><br><span class="line">        jedis.auth (password);</span><br><span class="line">    &#125;</span><br><span class="line"> ScanParams scanParams = <span class="keyword">new</span> ScanParams ().count (<span class="number">100</span>);</span><br><span class="line"> String cursor = <span class="string">&quot;0&quot;</span>;</span><br><span class="line"> <span class="keyword">do</span> &#123;</span><br><span class="line"> ScanResult&lt;String&gt; scanResult = jedis.sscan (bigSetKey, cursor, scanParams);</span><br><span class="line"> List&lt;String&gt; memberList = scanResult.getResult ();</span><br><span class="line"> <span class="keyword">if</span> (memberList != <span class="keyword">null</span> &amp;&amp; !memberList.isEmpty ()) &#123;</span><br><span class="line"> <span class="keyword">for</span> (String member : memberList) &#123;</span><br><span class="line">                jedis.srem (bigSetKey, member);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cursor = scanResult.getStringCursor ();</span><br><span class="line">    &#125; <span class="keyword">while</span> (!<span class="string">&quot;0&quot;</span>.equals (cursor));</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 删除 bigkey</span></span><br><span class="line">    jedis.del (bigSetKey);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h3 id="SortedSet-删除-zscan-zrem"><a href="#SortedSet-删除-zscan-zrem" class="headerlink" title="SortedSet 删除: zscan + zrem"></a>SortedSet 删除: zscan + zrem</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delBigZset</span><span class="params">(String host, <span class="keyword">int</span> port, String password, String bigZsetKey)</span> </span>&#123;</span><br><span class="line"> Jedis jedis = <span class="keyword">new</span> Jedis (host, port);</span><br><span class="line"> <span class="keyword">if</span> (password != <span class="keyword">null</span> &amp;&amp; !<span class="string">&quot;&quot;</span>.equals (password)) &#123;</span><br><span class="line">        jedis.auth (password);</span><br><span class="line">    &#125;</span><br><span class="line"> ScanParams scanParams = <span class="keyword">new</span> ScanParams ().count (<span class="number">100</span>);</span><br><span class="line"> String cursor = <span class="string">&quot;0&quot;</span>;</span><br><span class="line"> <span class="keyword">do</span> &#123;</span><br><span class="line"> ScanResult&lt;Tuple&gt; scanResult = jedis.zscan (bigZsetKey, cursor, scanParams);</span><br><span class="line"> List&lt;Tuple&gt; tupleList = scanResult.getResult ();</span><br><span class="line"> <span class="keyword">if</span> (tupleList != <span class="keyword">null</span> &amp;&amp; !tupleList.isEmpty ()) &#123;</span><br><span class="line"> <span class="keyword">for</span> (Tuple tuple : tupleList) &#123;</span><br><span class="line">                jedis.zrem (bigZsetKey, tuple.getElement ());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cursor = scanResult.getStringCursor ();</span><br><span class="line">    &#125; <span class="keyword">while</span> (!<span class="string">&quot;0&quot;</span>.equals (cursor));</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 删除 bigkey</span></span><br><span class="line">    jedis.del (bigZsetKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>原作者：付磊 - 起扬<br>原文链接：<a href="https://link.zhihu.com/?target=https%3A//yq.aliyun.com/articles/531067">阿里云 Redis 开发规范 - 云栖社区 - 阿里云</a><br>原出处：阿里云</p>
</blockquote>

        </div>

        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/Redis/"># Redis</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2017/01/09/Linux/%E5%B7%A5%E5%85%B7%E4%B9%8B%E7%AE%80%E6%98%8Etmux%E7%8E%A9%E6%B3%95%E6%95%99%E7%A8%8B/">简明 tmux 玩法教程</a>
            
            
            <a class="next" rel="next" href="/2017/01/05/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E4%B9%8B%E5%BE%AE%E6%9C%8D%E5%8A%A1/">什么是微服务</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span><a href="https://blog.maywzh.com" target="_blank">© maywzh</a>
            
        </span>
        
        <span> | <a href="https://beian.miit.gov.cn" target="_blank">鄂ICP备2020015912号-1</a></span>
        
    </div>
</footer>
    </div>
</body>
</html>
