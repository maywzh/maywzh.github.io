<!DOCTYPE HTML>
<html>

<head>
	<!-- hexo-inject:begin --><!-- hexo-inject:end --><link rel="bookmark" type="image/x-icon" href="/bitbug_favicon_64s.ico" />
	<link rel="shortcut icon" href="/bitbug_favicon_64s.ico">
	
	    <title>
    Cultoy
    </title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="/css/mic_main.css" />
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" />
    <link rel="stylesheet" href="/css/dropdownMenu.css" />
    <meta name="keywords" content="maywzh" />
    
    <noscript>
        <link rel="stylesheet" href="/css/noscript.css" />
    </noscript>
    <style type="text/css">
        body:before {
          content: ' ';
          position: fixed;
          top: 0;
          background: url('https://i.loli.net/2020/03/02/mYeD6WLp3kOy1qw.png') center 0 no-repeat;
          right: 0;
          bottom: 0;
          left: 0;
          background-size: cover; 
        }
    </style>

	    
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script async type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


    <script src="https://cdn.jsdelivr.net/gh/jquery/jquery@1.11.3/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ajlkn/jquery.scrollex@0.2.1/jquery.scrollex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/maywzh/jquery.scrolly@0.0.1/dist/jquery.scrolly.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ajlkn/skel@3.0.1/dist/skel.min.js"></script>
    <script src="/js/util.js"></script>
    <script src="/js/main.js"></script>
	
<meta name="generator" content="Hexo 5.1.1"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

<!-- Layouts -->



<!--  代码渲染  -->
<link rel="stylesheet" href="/css/prism_okaidia.css" />
<link rel="stylesheet" href="/css/typo.css" />
<!-- 文章页 -->

<body class="is-loading">
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><!-- Wrapper 外包 s-->
    <div id="wrapper" class="fade-in">
        <!-- Intro 头部显示 s -->
        <!-- Intro 头部显示 e -->
        <!-- Header 头部logo start -->
        <header id="header">
    <a href="/" class="logo">MAYWZH</a>
</header>
        <!-- Nav 导航条 start -->
        <nav id="nav" class="special">
	<ul class="menu links">
		<!-- Homepage  主页  -->
		<li>
			<a href="/" rel="nofollow">Home</a>
		</li>
		<!-- categories_name  分类   -->
		
		<li class="active">
			<a href="#s1">Category</a>
			<ul class="submenu">
				<li>
					<a class="category-link" href="/categories/DevOps/">DevOps</a></li><li><a class="category-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a></li><li><a class="category-link" href="/categories/%E5%88%B7%E9%A2%98/">刷题</a></li><li><a class="category-link" href="/categories/%E5%9D%91/">坑</a></li><li><a class="category-link" href="/categories/%E5%AF%86%E7%A0%81%E5%AD%A6/">密码学</a></li><li><a class="category-link" href="/categories/%E5%B7%A5%E5%85%B7/">工具</a></li><li><a class="category-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a></li><li><a class="category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></li><li><a class="category-link" href="/categories/%E6%96%B9%E6%B3%95%E8%AE%BA/">方法论</a></li><li><a class="category-link" href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">机器学习</a></li><li><a class="category-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a></li><li><a class="category-link" href="/categories/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/">系统设计</a></li><li><a class="category-link" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></li><li><a class="category-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/">计算机组成原理</a></li><li><a class="category-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a>
			</ul>
		</li>
		
		<!-- archives  归档   -->
		
		<li class="active">
			<a href="#s1">Archive</a>
			<ul class="submenu">
				<li>
					<a class="archive-link" href="/archives/2020/">2020</a></li><li><a class="archive-link" href="/archives/2019/">2019</a></li><li><a class="archive-link" href="/archives/2018/">2018</a></li><li><a class="archive-link" href="/archives/2017/">2017</a></li><li><a class="archive-link" href="/archives/2016/">2016</a></li><li><a class="archive-link" href="/archives/2015/">2015</a>
			</ul>
		</li>
		

		<!-- Pages 自定义   -->
		
		<li>
			<a href="/tags/" title="Tags">
				Tags
			</a>
		</li>
		
		<li>
			<a href="/about/" title="About">
				About
			</a>
		</li>
		


	</ul>
	<!-- icons 图标   -->
	<ul class="icons">
		
		<li>
			<a title="search" href="https://io.maywzh.com" target="_blank" rel="noopener">
				<i class="icon fa fa-search"></i>
			</a>
		</li>
		
		
		<li>
			<a title="twitter" href="https://twitter.com/maywzh" target="_blank" rel="noopener">
				<i class="icon fa fa-twitter"></i>
			</a>
		</li>
		
		<li>
			<a title="github" href="https://github.com/maywzh" target="_blank" rel="noopener">
				<i class="icon fa fa-github"></i>
			</a>
		</li>
		
	</ul>
</nav>

        <div id="main">
            <div class="post_page_title_img"
                style="height: 25rem;background-image: url(https://i.loli.net/2020/09/04/vY4eq6OIRotf19l.jpg);background-position: center; background-repeat:no-repeat; background-size:cover;-moz-background-size:cover;overflow:hidden;">
                <a href="#" style="padding: 4rem 4rem 2rem 4rem ;">
                    <h2>Go 语言的函数调用</h2>
                </a>
            </div>
            <!-- Post -->
            <div class="typo" style="padding: 3rem;">
                <p>函数是 Go 语言中的一等公民，理解和掌握函数的调用过程是我们深入学习 Go 无法跳过的，本节将从函数的调用惯例和参数的传递方法两个方面分别介绍函数的执行过程。</p>
<a id="more"></a>
<h2><span id="调用惯例">调用惯例 </span></h2><p> 无论是系统级编程语言 C 和 Go，还是脚本语言 Ruby 和 Python，这些编程语言在调用函数时往往都使用相同的语法：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">somefunction</span><span class="token punctuation">(</span>arg0<span class="token punctuation">,</span> arg1<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>虽然它们调用函数的语法很相似，但是它们的调用惯例却可能大不相同。调用惯例是调用方和被调用方对于参数和返回值传递的约定，我们将在这里为各位读者分别介绍 C 和 Go 语言的调用惯例。</p>
<h3><span id="c-语言">C 语言 </span></h3><p> 我们先来研究 C 语言的调用惯例，使用 <a target="_blank" rel="noopener" href="https://gcc.gnu.org/">GCC</a>和 <a target="_blank" rel="noopener" href="https://clang.llvm.org/">Clang</a>编译器将 C 语言编译成汇编代码是分析它调用惯例的最好方法，从汇编语言中可以一窥函数调用的具体过程。</p>
<p>GCC 和 Clang 编译相同 C 语言代码可能会生成不同的汇编指令，不过生成的代码在结构上不会有太大的区别，所以对只想理解调用惯例的人来说没有太多影响。作者在本节中选择使用 GCC 编译器来编译 C 语言：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ gcc --version
gcc <span class="token punctuation">(</span>Ubuntu <span class="token number">9.3</span>.0-10ubuntu2<span class="token punctuation">)</span> <span class="token number">9.3</span>.0
Copyright <span class="token punctuation">(</span>C<span class="token punctuation">)</span> <span class="token number">2019</span> Free Software Foundation, Inc.
This is <span class="token function">free</span> software<span class="token punctuation">;</span> see the <span class="token builtin class-name">source</span> <span class="token keyword">for</span> copyingconditions.  There is NO
warranty<span class="token punctuation">;</span> not even <span class="token keyword">for</span> MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>假设我们有以下的 C 语言代码，代码中只包含两个函数，其中一个是主函数 <code>main</code>，另一个是我们定义的函数 <code>my_function</code>：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// ch04/my_function.c</span>
<span class="token keyword">int</span> <span class="token function">my_function</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg1<span class="token punctuation">,</span> <span class="token keyword">int</span> arg2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> arg1 <span class="token operator">+</span> arg2<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">my_function</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们可以使用 <code>cc -S my_function.c</code> 命令将上述文件编译成如下所示的汇编代码：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">main<span class="token operator">:</span>
	pushq	<span class="token operator">%</span>rbp
	movq	<span class="token operator">%</span>rsp<span class="token punctuation">,</span> <span class="token operator">%</span>rbp
	subq	$<span class="token number">16</span><span class="token punctuation">,</span> <span class="token operator">%</span>rsp
	movl	$<span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">%</span>esi  <span class="token comment">// 设置第二个参数</span>
	movl	$<span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">%</span>edi  <span class="token comment">// 设置第一个参数</span>
	call	my_function
	movl	<span class="token operator">%</span>eax<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span>
my_function<span class="token operator">:</span>
	pushq	<span class="token operator">%</span>rbp
	movq	<span class="token operator">%</span>rsp<span class="token punctuation">,</span> <span class="token operator">%</span>rbp
	movl	<span class="token operator">%</span>edi<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span>    <span class="token comment">// 取出第一个参数，放到栈上</span>
	movl	<span class="token operator">%</span>esi<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span>    <span class="token comment">// 取出第二个参数，放到栈上</span>
	movl	<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>eax    <span class="token comment">// eax = esi = 1</span>
	movl	<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>edx    <span class="token comment">// edx = edi = 2</span>
	addl	<span class="token operator">%</span>edx<span class="token punctuation">,</span> <span class="token operator">%</span>eax        <span class="token comment">// eax = eax + edx = 1 + 2 = 3</span>
	popq	<span class="token operator">%</span>rbp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们按照 <code>my_function</code> 函数调用前、调用时以及调用后三个部分分析上述调用过程：</p>
<ul>
<li>在 <code>my_function</code> 调用之前，调用方 <code>main</code> 函数将 <code>my_function</code> 的两个参数分别存到 edi 和 esi 寄存器中；</li>
<li>在 <code>my_function</code> 执行时，它会将寄存器 edi 和 esi 中的数据存储到 eax 和 edx 两个寄存器中，随后通过汇编指令 <code>addl</code> 计算两个入参之和；</li>
<li>在 <code>my_function</code> 调用之后，使用寄存器 eax 传递返回值，<code>main</code> 函数将 <code>my_function</code> 的返回值存储到栈上的 <code>i</code> 变量中；</li>
</ul>
<p>当 <code>my_function</code> 函数的入参增加至八个，这时重新编译当前的程序可以会得到不同的汇编语言：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">main<span class="token operator">:</span>
	pushq	<span class="token operator">%</span>rbp
	movq	<span class="token operator">%</span>rsp<span class="token punctuation">,</span> <span class="token operator">%</span>rbp
	subq	$<span class="token number">16</span><span class="token punctuation">,</span> <span class="token operator">%</span>rsp     <span class="token comment">// 为参数传递申请 16 字节的栈空间</span>
	movl	$<span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>   <span class="token comment">// 传递第 8 个参数</span>
	movl	$<span class="token number">7</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">%</span>rsp<span class="token punctuation">)</span>    <span class="token comment">// 传递第 7 个参数</span>
	movl	$<span class="token number">6</span><span class="token punctuation">,</span> <span class="token operator">%</span>r9d
	movl	$<span class="token number">5</span><span class="token punctuation">,</span> <span class="token operator">%</span>r8d
	movl	$<span class="token number">4</span><span class="token punctuation">,</span> <span class="token operator">%</span>ecx
	movl	$<span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">%</span>edx
	movl	$<span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">%</span>esi
	movl	$<span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">%</span>edi
	call	my_function<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>main</code> 函数调用 <code>my_function</code> 时，前六个参数是使用 edi、esi、edx、ecx、r8d 和 r9d 六个寄存器传递的。寄存器的使用顺序也是调用惯例的一部分，函数的第一个参数一定会使用 edi 寄存器，第二个参数使用 esi 寄存器，以此类推。</p>
<p>最后的两个参数与前面的完全不同，调用方 <code>main</code> 函数通过传递这两个参数，图 4-1 展示了 <code>main</code> 函数在调用 <code>my_function</code> 前的栈信息：</p>
<p><img src="https://i.loli.net/2020/09/04/siN1dErocqeCAXb.png" alt="c-function-call-stack"></p>
<p>上图中 rbp 寄存器的作用是存储函数调用栈的基址指针，即属于 <code>main</code> 函数的栈空间的起始位置，而另一个寄存器 rsp 存储的是 <code>main</code> 函数调用栈结束的位置，这两个寄存器共同表示了一个函数的栈空间。</p>
<p>在调用 <code>my_function</code> 之前，<code>main</code> 函数通过 <code>subq $16, %rsp</code> 指令分配了 16 个字节的栈地址，随后将第六个以上的参数按照从右到左的顺序存入栈中，即第八个和第七个，余下的六个参数会通过寄存器传递，接下来运行的 <code>call my_function</code> 指令会调用 <code>my_function</code> 函数：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">my_function<span class="token operator">:</span>
	pushq	<span class="token operator">%</span>rbp
	movq	<span class="token operator">%</span>rsp<span class="token punctuation">,</span> <span class="token operator">%</span>rbp
	movl	<span class="token operator">%</span>edi<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span>    <span class="token comment">// rbp-4 = edi = 1</span>
	movl	<span class="token operator">%</span>esi<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span>    <span class="token comment">// rbp-8 = esi = 2</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	movl	<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>eax    <span class="token comment">// eax = 2</span>
	movl	<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>edx    <span class="token comment">// edx = 1</span>
	addl	<span class="token operator">%</span>eax<span class="token punctuation">,</span> <span class="token operator">%</span>edx        <span class="token comment">// edx = eax + edx = 3</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	movl	<span class="token number">16</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>eax    <span class="token comment">// eax = 7</span>
	addl	<span class="token operator">%</span>eax<span class="token punctuation">,</span> <span class="token operator">%</span>edx        <span class="token comment">// edx = eax + edx = 28</span>
	movl	<span class="token number">24</span><span class="token punctuation">(</span><span class="token operator">%</span>rbp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">%</span>eax    <span class="token comment">// eax = 8</span>
	addl	<span class="token operator">%</span>edx<span class="token punctuation">,</span> <span class="token operator">%</span>eax        <span class="token comment">// edx = eax + edx = 36</span>
	popq	<span class="token operator">%</span>rbp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>my_function</code> 会先将寄存器中的全部数据转移到栈上，然后利用 eax 寄存器计算所有入参的和并返回结果。</p>
<p>我们可以将本节的发现和分析简单总结成 —— 当我们在 x86_64 的机器上使用 C 语言中调用函数时，参数都是通过寄存器和栈传递的，其中：</p>
<ul>
<li>六个以及六个以下的参数会按照顺序分别使用 edi、esi、edx、ecx、r8d 和 r9d 六个寄存器传递；</li>
<li>六个以上的参数会使用栈传递，函数的参数会以从右到左的顺序依次存入栈中；</li>
</ul>
<p>而函数的返回值是通过 eax 寄存器进行传递的，由于只使用一个寄存器存储返回值，所以 C 语言的函数不能同时返回多个值。</p>
<h3><span id="go-语言">Go 语言 </span></h3><p> 分析了 C 语言函数的调用惯例之后，我们再来剖析一下 Go 语言中函数的调用惯例。我们以下面这个非常简单的代码片段为例简要分析一下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">func</span> <span class="token function">myFunction</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">,</span> a <span class="token operator">-</span> b
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">myFunction</span><span class="token punctuation">(</span><span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上述的 <code>myFunction</code> 函数接受两个整数并返回两个整数，<code>main</code> 函数在调用 <code>myFunction</code> 时将 66 和 77 两个参数传递到当前函数中，使用 <code>go tool compile -S -N -l main.go</code> 命令编译上述代码可以得到如下所示的汇编指令：</p>
<blockquote>
<p>注：如果编译时不使用 -N -l 参数，编译器会对汇编代码进行优化，编译结果会有较大差别。</p>
</blockquote>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token string">""</span><span class="token punctuation">.</span>main STEXT size<span class="token operator">=</span><span class="token number">68</span> args<span class="token operator">=</span><span class="token number">0x0</span> locals<span class="token operator">=</span><span class="token number">0x28</span>
	<span class="token number">0x0000</span> <span class="token number">00000</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">)</span>	MOVQ	<span class="token punctuation">(</span>TLS<span class="token punctuation">)</span><span class="token punctuation">,</span> CX
	<span class="token number">0x0009</span> <span class="token number">00009</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">)</span>	CMPQ	SP<span class="token punctuation">,</span> <span class="token function">16</span><span class="token punctuation">(</span>CX<span class="token punctuation">)</span>
	<span class="token number">0x000d</span> <span class="token number">00013</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">)</span>	JLS	<span class="token number">61</span>
	<span class="token number">0x000f</span> <span class="token number">00015</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">)</span>	SUBQ	$<span class="token number">40</span><span class="token punctuation">,</span> SP      <span class="token comment">// 分配 40 字节栈空间</span>
	<span class="token number">0x0013</span> <span class="token number">00019</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">)</span>	MOVQ	BP<span class="token punctuation">,</span> <span class="token function">32</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span>   <span class="token comment">// 将基址指针存储到栈上</span>
	<span class="token number">0x0018</span> <span class="token number">00024</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">)</span>	LEAQ	<span class="token function">32</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span><span class="token punctuation">,</span> BP
	<span class="token number">0x001d</span> <span class="token number">00029</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">)</span>	MOVQ	$<span class="token number">66</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>SP<span class="token punctuation">)</span>    <span class="token comment">// 第一个参数</span>
	<span class="token number">0x0025</span> <span class="token number">00037</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">)</span>	MOVQ	$<span class="token number">77</span><span class="token punctuation">,</span> <span class="token function">8</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span>   <span class="token comment">// 第二个参数</span>
	<span class="token number">0x002e</span> <span class="token number">00046</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">)</span>	CALL	<span class="token string">""</span><span class="token punctuation">.</span><span class="token function">myFunction</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span>
	<span class="token number">0x0033</span> <span class="token number">00051</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">)</span>	MOVQ	<span class="token function">32</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span><span class="token punctuation">,</span> BP
	<span class="token number">0x0038</span> <span class="token number">00056</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">)</span>	ADDQ	$<span class="token number">40</span><span class="token punctuation">,</span> SP
	<span class="token number">0x003c</span> <span class="token number">00060</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">)</span>	RET<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据 <code>main</code> 函数生成的汇编指令，我们可以分析出 <code>main</code> 函数调用 <code>myFunction</code> 之前的栈情况：</p>
<p><img src="https://i.loli.net/2020/09/04/JRUEtl4yHBY6TXq.png" alt="golang-function-call-stack-before-calling"></p>
<p><code>main</code> 函数通过 <code>SUBQ $40, SP</code> 指令一共在栈上分配了 40 字节的内存空间：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>空间</th>
<th>大小</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>SP+32 ~ BP</td>
<td>8 字节</td>
<td><code>main</code> 函数的栈基址指针</td>
</tr>
<tr>
<td>SP+16 ~ SP+32</td>
<td>16 字节</td>
<td>函数 <code>myFunction</code> 的两个返回值</td>
</tr>
<tr>
<td>SP ~ SP+16</td>
<td>16 字节</td>
<td>函数 <code>myFunction</code> 的两个参数</td>
</tr>
</tbody>
</table>
</div>
<p><code>myFunction</code> 入参的压栈顺序和 C 语言一样，都是从右到左，即第一个参数 66 在栈顶的 SP ~ SP+8，第二个参数存储在 SP+8 ~ SP+16 的空间中。</p>
<p>当我们准备好函数的入参之后，会调用汇编指令 <code>CALL &quot;&quot;.myFunction(SB)</code>，这个指令首先会将 <code>main</code> 的返回地址存入栈中，然后改变当前的栈指针 SP 并开始执行 <code>myFunction</code> 的汇编指令：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token string">""</span><span class="token punctuation">.</span>myFunction STEXT nosplit size<span class="token operator">=</span><span class="token number">49</span> args<span class="token operator">=</span><span class="token number">0x20</span> locals<span class="token operator">=</span><span class="token number">0x0</span>
	<span class="token number">0x0000</span> <span class="token number">00000</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">)</span>	MOVQ	$<span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">.</span>~r2<span class="token operator">+</span><span class="token function">24</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span> <span class="token comment">// 初始化第一个返回值</span>
	<span class="token number">0x0009</span> <span class="token number">00009</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">)</span>	MOVQ	$<span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">.</span>~r3<span class="token operator">+</span><span class="token function">32</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span> <span class="token comment">// 初始化第二个返回值</span>
	<span class="token number">0x0012</span> <span class="token number">00018</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">)</span>	MOVQ	<span class="token string">""</span><span class="token punctuation">.</span>a<span class="token operator">+</span><span class="token function">8</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span><span class="token punctuation">,</span> AX    <span class="token comment">// AX = 66</span>
	<span class="token number">0x0017</span> <span class="token number">00023</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">)</span>	ADDQ	<span class="token string">""</span><span class="token punctuation">.</span>b<span class="token operator">+</span><span class="token function">16</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span><span class="token punctuation">,</span> AX   <span class="token comment">// AX = AX + 77 = 143</span>
	<span class="token number">0x001c</span> <span class="token number">00028</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">)</span>	MOVQ	AX<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">.</span>~r2<span class="token operator">+</span><span class="token function">24</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span> <span class="token comment">// (24)SP = AX = 143</span>
	<span class="token number">0x0021</span> <span class="token number">00033</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">)</span>	MOVQ	<span class="token string">""</span><span class="token punctuation">.</span>a<span class="token operator">+</span><span class="token function">8</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span><span class="token punctuation">,</span> AX    <span class="token comment">// AX = 66</span>
	<span class="token number">0x0026</span> <span class="token number">00038</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">)</span>	SUBQ	<span class="token string">""</span><span class="token punctuation">.</span>b<span class="token operator">+</span><span class="token function">16</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span><span class="token punctuation">,</span> AX   <span class="token comment">// AX = AX - 77 = -11</span>
	<span class="token number">0x002b</span> <span class="token number">00043</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">)</span>	MOVQ	AX<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">.</span>~r3<span class="token operator">+</span><span class="token function">32</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span> <span class="token comment">// (32)SP = AX = -11</span>
	<span class="token number">0x0030</span> <span class="token number">00048</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">)</span>	RET<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从上述的汇编代码中我们可以看出，当前函数在执行时首先会将 <code>main</code> 函数中预留的两个返回值地址置成 <code>int</code> 类型的默认值 0，然后根据栈的相对位置获取参数并进行加减操作并将值存回栈中，在 <code>myFunction</code> 函数返回之间，栈中的数据如图 4-3 所示：</p>
<p><img src="https://i.loli.net/2020/09/04/VY1tQJNkSi94sDv.png" alt="golang-function-call-stack-before-return"></p>
<p>在 <code>myFunction</code> 返回之后，<code>main</code> 函数会通过以下的指令来恢复栈基址指针并销毁已经失去作用的 40 字节的栈空间：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token number">0x0033</span> <span class="token number">00051</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">)</span>    MOVQ    <span class="token function">32</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span><span class="token punctuation">,</span> BP
<span class="token number">0x0038</span> <span class="token number">00056</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">)</span>    ADDQ    $<span class="token number">40</span><span class="token punctuation">,</span> SP
<span class="token number">0x003c</span> <span class="token number">00060</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">)</span>    RET<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>通过分析 Go 语言编译后的汇编指令，我们发现 Go 语言使用栈传递参数和接收返回值，所以它只需要在栈上多分配一些内存就可以返回多个值。</p>
<h3><span id="思考">思考</span></h3><p>C 语言和 Go 语言在设计函数的调用惯例时选择也不同的实现。C 语言同时使用寄存器和栈传递参数，使用 eax 寄存器传递返回值；而 Go 语言使用栈传递参数和返回值。我们可以对比一下这两种设计的优点和缺点：</p>
<ul>
<li>C 语言的方式能够极大地减少函数调用的额外开销，但是也增加了实现的复杂度；<ul>
<li>CPU 访问栈的开销比访问寄存器高几十倍；</li>
<li>需要单独处理函数参数过多的情况；</li>
</ul>
</li>
<li>Go 语言的方式能够降低实现的复杂度并支持多返回值，但是牺牲了函数调用的性能；<ul>
<li>不需要考虑超过寄存器数量的参数应该如何传递；</li>
<li>不需要考虑不同架构上的寄存器差异；</li>
<li>函数入参和出参的内存空间需要在栈上进行分配；</li>
</ul>
</li>
</ul>
<p>Go 语言使用栈作为参数和返回值传递的方法是综合考虑后的设计，选择这种设计意味着编译器会更加简单、更容易维护。</p>
<h2><span id="参数传递">参数传递 </span></h2><p> 除了函数的调用惯例之外，Go 语言在传递参数时是传值还是传引用也是一个有趣的问题，这个问题影响的是当我们在函数中对入参进行修改时会不会影响调用方看到的数据。我们先来介绍一下传值和传引用两者的区别：</p>
<ul>
<li>传值：函数调用时会对参数进行拷贝，被调用方和调用方两者持有不相关的两份数据；</li>
<li>传引用：函数调用时会传递参数的指针，被调用方和调用方两者持有相同的数据，任意一方做出的修改都会影响另一方。</li>
</ul>
<p>不同语言会选择不同的方式传递参数，Go 语言选择了传值的方式，<strong>无论是传递基本类型、结构体还是指针，都会对传递的参数进行拷贝</strong>。本节剩下的内容将会验证这个结论的正确性。</p>
<h3><span id="整型和数组">整型和数组 </span></h3><p> 我们先来分析 Go 语言是如何传递基本类型和数组的。如下所示的函数 <code>myFunction</code> 接收了两个参数，整型变量 <code>i</code> 和数组 <code>arr</code>，这个函数会将传入的两个参数的地址打印出来，在最外层的主函数也会在 <code>myFunction</code> 函数调用前后分别打印两个参数的地址：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">myFunction</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">,</span> arr <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"in my_funciton - i=(%d, %p) arr=(%v, %p)\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>i<span class="token punctuation">,</span> arr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arr<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	i <span class="token operator">:=</span> <span class="token number">30</span>
	arr <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">&#123;</span><span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">&#125;</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"before calling - i=(%d, %p) arr=(%v, %p)\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>i<span class="token punctuation">,</span> arr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arr<span class="token punctuation">)</span>
	<span class="token function">myFunction</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> arr<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"after  calling - i=(%d, %p) arr=(%v, %p)\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>i<span class="token punctuation">,</span> arr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arr<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

$ <span class="token keyword">go</span> run main<span class="token punctuation">.</span><span class="token keyword">go</span>
before calling <span class="token operator">-</span> i<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">0xc00009a000</span><span class="token punctuation">)</span> arr<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">66</span> <span class="token number">77</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0xc00009a010</span><span class="token punctuation">)</span>
in my_funciton <span class="token operator">-</span> i<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">0xc00009a008</span><span class="token punctuation">)</span> arr<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">66</span> <span class="token number">77</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0xc00009a020</span><span class="token punctuation">)</span>
after  calling <span class="token operator">-</span> i<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">0xc00009a000</span><span class="token punctuation">)</span> arr<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">66</span> <span class="token number">77</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0xc00009a010</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当我们通过命令运行这段代码我们会发现，<code>main</code> 函数和被调用者 <code>myFunction</code> 中参数的地址是完全不同的。</p>
<p>不过从 <code>main</code> 函数的角度来看，在调用 <code>myFunction</code> 前后，整数 <code>i</code> 和数组 <code>arr</code> 两个参数的地址都没有变化。那么如果我们在 <code>myFunction</code> 函数内部对参数进行修改是否会影响 <code>main</code> 函数中的变量呢？我们更新 <code>myFunction</code> 函数并重新执行这段代码：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">myFunction</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">,</span> arr <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	i <span class="token operator">=</span> <span class="token number">29</span>
	arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">88</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"in my_funciton - i=(%d, %p) arr=(%v, %p)\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>i<span class="token punctuation">,</span> arr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arr<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

$ <span class="token keyword">go</span> run main<span class="token punctuation">.</span><span class="token keyword">go</span>
before calling <span class="token operator">-</span> i<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">0xc000072008</span><span class="token punctuation">)</span> arr<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">66</span> <span class="token number">77</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0xc000072010</span><span class="token punctuation">)</span>
in my_funciton <span class="token operator">-</span> i<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">29</span><span class="token punctuation">,</span> <span class="token number">0xc000072028</span><span class="token punctuation">)</span> arr<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">66</span> <span class="token number">88</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0xc000072040</span><span class="token punctuation">)</span>
after  calling <span class="token operator">-</span> i<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">0xc000072008</span><span class="token punctuation">)</span> arr<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">66</span> <span class="token number">77</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0xc000072010</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>你可以看到在 <code>myFunction</code> 中对参数的修改也仅仅影响了当前函数，并没有影响调用方 <code>main</code> 函数，所以我们能给出如下的结论 - <strong>Go 语言中对于整型和数组类型的参数都是值传递的</strong>，也就是在调用函数时会对内容进行拷贝，需要注意的是如果当前数组的大小非常的大，这种传值方式就会对性能造成比较大的影响。</p>
<h3><span id="结构体和指针">结构体和指针 </span></h3><p> 接下来我们继续分析 Go 语言另外两种常见类型 —— 结构体和指针。在这段代码中定义一个只包含一个成员变量的简单结构体 <code>MyStruct</code> 以及接受两个参数的 <code>myFunction</code> 方法：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> MyStruct <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	i <span class="token builtin">int</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">myFunction</span><span class="token punctuation">(</span>a MyStruct<span class="token punctuation">,</span> b <span class="token operator">*</span>MyStruct<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	a<span class="token punctuation">.</span>i <span class="token operator">=</span> <span class="token number">31</span>
	b<span class="token punctuation">.</span>i <span class="token operator">=</span> <span class="token number">41</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"in my_function - a=(%d, %p) b=(%v, %p)\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token operator">&amp;</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token operator">&amp;</span>b<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	a <span class="token operator">:=</span> MyStruct<span class="token punctuation">&#123;</span>i<span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">&#125;</span>
	b <span class="token operator">:=</span> <span class="token operator">&amp;</span>MyStruct<span class="token punctuation">&#123;</span>i<span class="token punctuation">:</span> <span class="token number">40</span><span class="token punctuation">&#125;</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"before calling - a=(%d, %p) b=(%v, %p)\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token operator">&amp;</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token operator">&amp;</span>b<span class="token punctuation">)</span>
	<span class="token function">myFunction</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"after calling  - a=(%d, %p) b=(%v, %p)\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token operator">&amp;</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token operator">&amp;</span>b<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

$ <span class="token keyword">go</span> run main<span class="token punctuation">.</span><span class="token keyword">go</span>
before calling <span class="token operator">-</span> a<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token number">30</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">0xc000018178</span><span class="token punctuation">)</span> b<span class="token operator">=</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">&#123;</span><span class="token number">40</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">0xc00000c028</span><span class="token punctuation">)</span>
in my_function <span class="token operator">-</span> a<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token number">31</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">0xc000018198</span><span class="token punctuation">)</span> b<span class="token operator">=</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">&#123;</span><span class="token number">41</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">0xc00000c038</span><span class="token punctuation">)</span>
after calling  <span class="token operator">-</span> a<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token number">30</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">0xc000018178</span><span class="token punctuation">)</span> b<span class="token operator">=</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">&#123;</span><span class="token number">41</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">0xc00000c028</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从运行的结果我们可以得出如下结论：</p>
<ul>
<li>传递结构体时：会对结构体中的全部内容进行拷贝；</li>
<li>传递结构体指针时：会对结构体指针进行拷贝；</li>
</ul>
<p>对结构体指针的修改是改变了指针指向的结构体，<code>b.i</code> 可以被理解成 <code>(*b).i</code>，也就是我们先获取指针 <code>b</code> 背后的结构体，再修改结构体的成员变量。我们简单修改上述代码，分析一下 Go 语言结构体在内存中的布局：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> MyStruct <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	i <span class="token builtin">int</span>
	j <span class="token builtin">int</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">myFunction</span><span class="token punctuation">(</span>ms <span class="token operator">*</span>MyStruct<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	ptr <span class="token operator">:=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		c <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token operator">*</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token operator">*</span>c <span class="token operator">+=</span> i <span class="token operator">+</span> <span class="token number">1</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"[%p] %d\n"</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token operator">*</span>c<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	a <span class="token operator">:=</span> <span class="token operator">&amp;</span>MyStruct<span class="token punctuation">&#123;</span>i<span class="token punctuation">:</span> <span class="token number">40</span><span class="token punctuation">,</span> j<span class="token punctuation">:</span> <span class="token number">50</span><span class="token punctuation">&#125;</span>
	<span class="token function">myFunction</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"[%p] %v\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

$ <span class="token keyword">go</span> run main<span class="token punctuation">.</span><span class="token keyword">go</span>
<span class="token punctuation">[</span><span class="token number">0xc000018180</span><span class="token punctuation">]</span> <span class="token number">41</span>
<span class="token punctuation">[</span><span class="token number">0xc000018188</span><span class="token punctuation">]</span> <span class="token number">52</span>
<span class="token punctuation">[</span><span class="token number">0xc000018180</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span><span class="token punctuation">&#123;</span><span class="token number">41</span> <span class="token number">52</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这段代码中，我们通过指针的方式修改结构体中的成员变量，结构体在内存中是一片连续的空间，指向结构体的指针也是指向这个结构体的首地址。将 <code>MyStruct</code> 指针修改成 <code>int</code> 类型的，那么访问新指针就会返回整型变量 <code>i</code>，将指针移动 8 个字节之后就能获取下一个成员变量 <code>j</code>。</p>
<p>如果我们将上述代码简化成如下所示的代码片段并使用 <code>go tool compile</code> 进行编译会得到如下的结果：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> MyStruct <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	i <span class="token builtin">int</span>
	j <span class="token builtin">int</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">myFunction</span><span class="token punctuation">(</span>ms <span class="token operator">*</span>MyStruct<span class="token punctuation">)</span> <span class="token operator">*</span>MyStruct <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> ms
<span class="token punctuation">&#125;</span>

$ <span class="token keyword">go</span> tool compile <span class="token operator">-</span>S <span class="token operator">-</span>N <span class="token operator">-</span>l main<span class="token punctuation">.</span><span class="token keyword">go</span>
<span class="token string">""</span><span class="token punctuation">.</span>myFunction STEXT nosplit size<span class="token operator">=</span><span class="token number">20</span> args<span class="token operator">=</span><span class="token number">0x10</span> locals<span class="token operator">=</span><span class="token number">0x0</span>
	<span class="token number">0x0000</span> <span class="token number">00000</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">)</span>	MOVQ	$<span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">.</span>~r1<span class="token operator">+</span><span class="token function">16</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span> <span class="token comment">// 初始化返回值</span>
	<span class="token number">0x0009</span> <span class="token number">00009</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">)</span>	MOVQ	<span class="token string">""</span><span class="token punctuation">.</span>ms<span class="token operator">+</span><span class="token function">8</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span><span class="token punctuation">,</span> AX   <span class="token comment">// 复制引用</span>
	<span class="token number">0x000e</span> <span class="token number">00014</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">)</span>	MOVQ	AX<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">.</span>~r1<span class="token operator">+</span><span class="token function">16</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span> <span class="token comment">// 返回引用</span>
	<span class="token number">0x0013</span> <span class="token number">00019</span> <span class="token punctuation">(</span>main<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">)</span>	RET<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这段汇编语言中我们发现当参数是指针时，也会使用 <code>MOVQ &quot;&quot;.ms+8(SP), AX</code> 指令对引用进行复制，然后将复制后的指针作为返回值传递回调用方。</p>
<p><img src="https://i.loli.net/2020/09/04/DIEtN3Tvl764BZi.png" alt="golang-pointer-as-argument"></p>
<p>所以将指针作为参数传入某一个函数时，在函数内部会对指针进行复制，也就是会同时出现两个指针指向原有的内存空间，所以 Go 语言中『传指针』也是传值。</p>
<h3><span id="传值">传值 </span></h3><p> 当我们对 Go 语言中大多数常见的数据结构进行验证之后，其实就能够推测出 Go 语言在传递参数时其实使用的就是传值的方式，接收方收到参数时会对这些参数进行复制；了解到这一点之后，在传递数组或者内存占用非常大的结构体时，我们在一些函数中应该尽量使用指针作为参数类型来避免发生大量数据的拷贝而影响性能。</p>
<h2><span id="小结">小结 </span></h2><p> 这一节我们详细分析了 Go 语言的调用惯例，包括传递参数和返回值的过程和原理。Go 通过栈传递函数的参数和返回值，在调用函数之前会在栈上为返回值分配合适的内存空间，随后将入参从右到左按顺序压栈并拷贝参数，返回值会被存储到调用方预留好的栈空间上，我们可以简单总结出以下几条规则：</p>
<ol>
<li>通过堆栈传递参数，入栈的顺序是从右到左；</li>
<li>函数返回值通过堆栈传递并由调用者预先分配内存空间；</li>
<li>调用函数时都是传值，接收方会对入参进行复制再计算；</li>
</ol>

            </div>
            <!-- Post Comments -->
            
        </div>
        <!-- Copyright 版权 start -->
        <div id="copyright">
    <ul>
        <li>&copy;Powered By <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/" style="border-bottom: none;">hexo</a></li>
        <li>Theme: <a target="_blank" rel="noopener" href="http://miccall.tech " style="border-bottom: none;">miccall</a></li>
        <!-- <li><a href="">鄂ICP备2020015912号-1</a></li> -->
    </ul>
    
    <span id="busuanzi_container_site_pv"> 2020 </span>
    
</div>
    </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>





</html>