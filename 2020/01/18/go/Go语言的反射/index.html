<!DOCTYPE HTML>
<html>

<head>
	<link rel="bookmark" type="image/x-icon" href="/bitbug_favicon_64s.ico" />
	<link rel="shortcut icon" href="/bitbug_favicon_64s.ico">
	
	    <title>
    Cultoy
    </title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="/css/mic_main.css" />
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" />
    <link rel="stylesheet" href="/css/dropdownMenu.css" />
    <meta name="keywords" content="maywzh" />
    
    <noscript>
        <link rel="stylesheet" href="/css/noscript.css" />
    </noscript>
    <style type="text/css">
        body:before {
          content: ' ';
          position: fixed;
          top: 0;
          background: url('https://i.loli.net/2020/03/02/mYeD6WLp3kOy1qw.png') center 0 no-repeat;
          right: 0;
          bottom: 0;
          left: 0;
          background-size: cover; 
        }
    </style>

	    
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script async type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


    <script src="https://cdn.jsdelivr.net/gh/jquery/jquery@1.11.3/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ajlkn/jquery.scrollex@0.2.1/jquery.scrollex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/maywzh/jquery.scrolly@0.0.1/dist/jquery.scrolly.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ajlkn/skel@3.0.1/dist/skel.min.js"></script>
    <script src="/js/util.js"></script>
    <script src="/js/main.js"></script>
	
<meta name="generator" content="Hexo 5.1.1"></head>

<!-- Layouts -->



<!--  代码渲染  -->
<link rel="stylesheet" href="/css/prism_okaidia.css" />
<link rel="stylesheet" href="/css/typo.css" />
<!-- 文章页 -->

<body class="is-loading">
    <!-- Wrapper 外包 s-->
    <div id="wrapper" class="fade-in">
        <!-- Intro 头部显示 s -->
        <!-- Intro 头部显示 e -->
        <!-- Header 头部logo start -->
        <header id="header">
    <a href="/" class="logo">MAYWZH</a>
</header>
        <!-- Nav 导航条 start -->
        <nav id="nav" class="special">
	<ul class="menu links">
		<!-- Homepage  主页  -->
		<li>
			<a href="/" rel="nofollow">Home</a>
		</li>
		<!-- categories_name  分类   -->
		
		<li class="active">
			<a href="#s1">Category</a>
			<ul class="submenu">
				<li>
					<a class="category-link" href="/categories/DevOps/">DevOps</a></li><li><a class="category-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a></li><li><a class="category-link" href="/categories/%E5%88%B7%E9%A2%98/">刷题</a></li><li><a class="category-link" href="/categories/%E5%9D%91/">坑</a></li><li><a class="category-link" href="/categories/%E5%AF%86%E7%A0%81%E5%AD%A6/">密码学</a></li><li><a class="category-link" href="/categories/%E5%B7%A5%E5%85%B7/">工具</a></li><li><a class="category-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a></li><li><a class="category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></li><li><a class="category-link" href="/categories/%E6%96%B9%E6%B3%95%E8%AE%BA/">方法论</a></li><li><a class="category-link" href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">机器学习</a></li><li><a class="category-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a></li><li><a class="category-link" href="/categories/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/">系统设计</a></li><li><a class="category-link" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></li><li><a class="category-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/">计算机组成原理</a></li><li><a class="category-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a>
			</ul>
		</li>
		
		<!-- archives  归档   -->
		
		<li class="active">
			<a href="#s1">Archive</a>
			<ul class="submenu">
				<li>
					<a class="archive-link" href="/archives/2020/">2020</a></li><li><a class="archive-link" href="/archives/2019/">2019</a></li><li><a class="archive-link" href="/archives/2018/">2018</a></li><li><a class="archive-link" href="/archives/2017/">2017</a></li><li><a class="archive-link" href="/archives/2016/">2016</a></li><li><a class="archive-link" href="/archives/2015/">2015</a>
			</ul>
		</li>
		

		<!-- Pages 自定义   -->
		
		<li>
			<a href="/tags/" title="Tags">
				Tags
			</a>
		</li>
		
		<li>
			<a href="/about/" title="About">
				About
			</a>
		</li>
		


	</ul>
	<!-- icons 图标   -->
	<ul class="icons">
		
		<li>
			<a title="search" href="https://io.maywzh.com" target="_blank" rel="noopener">
				<i class="icon fa fa-search"></i>
			</a>
		</li>
		
		
		<li>
			<a title="twitter" href="https://twitter.com/maywzh" target="_blank" rel="noopener">
				<i class="icon fa fa-twitter"></i>
			</a>
		</li>
		
		<li>
			<a title="github" href="https://github.com/maywzh" target="_blank" rel="noopener">
				<i class="icon fa fa-github"></i>
			</a>
		</li>
		
	</ul>
</nav>

        <div id="main">
            <div class="post_page_title_img"
                style="height: 25rem;background-image: url(https://i.loli.net/2020/12/26/acjRWpdMxSnIBUq.png);background-position: center; background-repeat:no-repeat; background-size:cover;-moz-background-size:cover;overflow:hidden;">
                <a href="#" style="padding: 4rem 4rem 2rem 4rem ;">
                    <h2>Go语言的反射</h2>
                </a>
            </div>
            <!-- Post -->
            <div class="typo" style="padding: 3rem;">
                <p>反射是 Go 语言比较重要的特性。虽然在大多数的应用和服务中并不常见，但是很多框架都依赖 Go 语言的反射机制实现简化代码的逻辑。因为 Go 语言的语法元素很少、设计简单，所以它没有特别强的表达能力，但是 Go 语言的 <a target="_blank" rel="noopener" href="https://golang.org/pkg/reflect/"><code>reflect</code></a> 包能够弥补它在语法上的一些劣势。</p>
<a id="more"></a>
<p><a target="_blank" rel="noopener" href="https://golang.org/pkg/reflect/"><code>reflect</code></a> 实现了运行时的反射能力，能够让程序操作不同类型的对象。反射包中有两对非常重要的函数和类型，<a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/52c4488471ed52085a29e173226b3cbd2bf22b20/src/reflect/type.go#L1365-L1368"><code>reflect.TypeOf</code></a> 能获取类型信息，<a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/52c4488471ed52085a29e173226b3cbd2bf22b20/src/reflect/value.go#L2316-L2328"><code>reflect.ValueOf</code></a> 能获取数据的运行时表示，另外两个类型是 <code>Type</code> 和 <code>Value</code>，它们与函数是一一对应的关系：</p>
<p><img src="https://i.loli.net/2020/09/11/ed6U9csrRv57onb.png" alt="golang-reflection"></p>
<p>类型 <code>Type</code> 是反射包定义的一个接口，我们可以使用 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/52c4488471ed52085a29e173226b3cbd2bf22b20/src/reflect/type.go#L1365-L1368"><code>reflect.TypeOf</code></a> 函数获取任意变量的的类型，<code>Type</code> 接口中定义了一些有趣的方法，<code>MethodByName</code> 可以获取当前类型对应方法的引用、<code>Implements</code> 可以判断当前类型是否实现了某个接口：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Type <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span>
        <span class="token function">Align</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
        <span class="token function">FieldAlign</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
        <span class="token function">Method</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span> Method
        <span class="token function">MethodByName</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Method<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span>
        <span class="token function">NumMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
        <span class="token operator">...</span>
        <span class="token function">Implements</span><span class="token punctuation">(</span>u Type<span class="token punctuation">)</span> <span class="token builtin">bool</span>
        <span class="token operator">...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>反射包中 <code>Value</code> 的类型与 <code>Type</code> 不同，它被声明成了结构体。这个结构体没有对外暴露的字段，但是提供了获取或者写入数据的方法：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Value <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// contains filtered or unexported fields</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>v Value<span class="token punctuation">)</span> <span class="token function">Addr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Value
<span class="token keyword">func</span> <span class="token punctuation">(</span>v Value<span class="token punctuation">)</span> <span class="token function">Bool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>v Value<span class="token punctuation">)</span> <span class="token function">Bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
<span class="token operator">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>反射包中的所有方法基本都是围绕着 <code>Type</code> 和 <code>Value</code> 这两个类型设计的。我们通过 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/52c4488471ed52085a29e173226b3cbd2bf22b20/src/reflect/type.go#L1365-L1368"><code>reflect.TypeOf</code></a>、<a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/52c4488471ed52085a29e173226b3cbd2bf22b20/src/reflect/value.go#L2316-L2328"><code>reflect.ValueOf</code></a> 可以将一个普通的变量转换成『反射』包中提供的 <code>Type</code> 和 <code>Value</code>，随后就可以使用反射包中的方法对它们进行复杂的操作。</p>
<h2 id="三大法则"><a href="#三大法则" class="headerlink" title="三大法则"></a>三大法则</h2><p>运行时反射是程序在运行期间检查其自身结构的一种方式。反射带来的灵活性是一把双刃剑，反射作为一种元编程方式可以减少重复代码，其中包括：</p>
<ol>
<li>从 <code>interface&#123;&#125;</code> 变量可以反射出反射对象；</li>
<li>从反射对象可以获取 <code>interface&#123;&#125;</code> 变量；</li>
<li>要修改反射对象，其值必须可设置；</li>
</ol>
<h3 id="第一法则"><a href="#第一法则" class="headerlink" title="第一法则"></a>第一法则</h3><p>反射的第一法则是我们能将 Go 语言的 <code>interface&#123;&#125;</code> 变量转换成反射对象。很多读者可能会对这以法则产生困惑 —— 为什么是从 <code>interface&#123;&#125;</code> 变量到反射对象？当我们执行 <code>reflect.ValueOf(1)</code> 时，虽然看起来是获取了基本类型 <code>int</code> 对应的反射类型，但是由于 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/52c4488471ed52085a29e173226b3cbd2bf22b20/src/reflect/type.go#L1365-L1368"><code>reflect.TypeOf</code></a>、<a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/52c4488471ed52085a29e173226b3cbd2bf22b20/src/reflect/value.go#L2316-L2328"><code>reflect.ValueOf</code></a> 两个方法的入参都是 <code>interface&#123;&#125;</code> 类型，所以在方法执行的过程中发生了类型转换。</p>
<p>在<a target="_blank" rel="noopener" href="http://draveness.me/golang-function-call">函数调用</a>一节中曾经介绍过，Go 语言的函数调用都是值传递的，变量会在函数调用时进行类型转换。基本类型 <code>int</code> 会转换成 <code>interface&#123;&#125;</code> 类型，这也就是为什么第一条法则是『从接口到反射对象』。</p>
<p>上面提到的 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/52c4488471ed52085a29e173226b3cbd2bf22b20/src/reflect/type.go#L1365-L1368"><code>reflect.TypeOf</code></a> 和 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/52c4488471ed52085a29e173226b3cbd2bf22b20/src/reflect/value.go#L2316-L2328"><code>reflect.ValueOf</code></a> 函数就能完成这里的转换，如果我们认为 Go 语言的类型和反射类型处于两个不同的『世界』，那么这两个函数就是连接这两个世界的桥梁。</p>
<p><img src="https://i.loli.net/2020/09/11/4itVukPmpZM73dg.png" alt="golang-interface-to-reflection"></p>
<p><strong>接口到反射对象</strong></p>
<p>我们通过以下例子简单介绍这两个函数的作用，<a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/52c4488471ed52085a29e173226b3cbd2bf22b20/src/reflect/type.go#L1365-L1368"><code>reflect.TypeOf</code></a> 获取了变量 <code>author</code> 的类型，<a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/52c4488471ed52085a29e173226b3cbd2bf22b20/src/reflect/value.go#L2316-L2328"><code>reflect.ValueOf</code></a> 获取了变量的值 <code>draven</code>。如果我们知道了一个变量的类型和值，那么就意味着知道了这个变量的全部信息。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"reflect"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	author <span class="token operator">:=</span> <span class="token string">"draven"</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"TypeOf author:"</span><span class="token punctuation">,</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>author<span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"ValueOf author:"</span><span class="token punctuation">,</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>author<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

$ <span class="token keyword">go</span> run main<span class="token punctuation">.</span><span class="token keyword">go</span>
TypeOf author<span class="token punctuation">:</span> <span class="token builtin">string</span>
ValueOf author<span class="token punctuation">:</span> draven<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>有了变量的类型之后，我们可以通过 <code>Method</code> 方法获得类型实现的方法，通过 <code>Field</code> 获取类型包含的全部字段。对于不同的类型，我们也可以调用不同的方法获取相关信息：</p>
<ul>
<li>结构体：获取字段的数量并通过下标和字段名获取字段 <code>StructField</code>；</li>
<li>哈希表：获取哈希表的 <code>Key</code> 类型；</li>
<li>函数或方法：获取入参和返回值的类型；</li>
<li>…</li>
</ul>
<p>总而言之，使用 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/52c4488471ed52085a29e173226b3cbd2bf22b20/src/reflect/type.go#L1365-L1368"><code>reflect.TypeOf</code></a> 和 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/52c4488471ed52085a29e173226b3cbd2bf22b20/src/reflect/value.go#L2316-L2328"><code>reflect.ValueOf</code></a> 能够获取 Go 语言中的变量对应的反射对象。一旦获取了反射对象，我们就能得到跟当前类型相关数据和操作，并可以使用这些运行时获取的结构执行方法。</p>
<h3 id="第二法则"><a href="#第二法则" class="headerlink" title="第二法则"></a>第二法则</h3><p>反射的第二法则是我们可以从反射对象可以获取 <code>interface&#123;&#125;</code> 变量。既然能够将接口类型的变量转换成反射对象，那么一定需要其他方法将反射对象还原成接口类型的变量，<a target="_blank" rel="noopener" href="https://golang.org/pkg/reflect/"><code>reflect</code></a> 中的 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/52c4488471ed52085a29e173226b3cbd2bf22b20/src/reflect/value.go#L992-L994"><code>reflect.Value.Interface</code></a> 方法就能完成这项工作：</p>
<p><img src="https://i.loli.net/2020/09/11/bvghG2u3EILPRrx.png" alt="golang-reflection-to-interface"></p>
<p><strong>反射对象到接口</strong></p>
<p>不过调用 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/52c4488471ed52085a29e173226b3cbd2bf22b20/src/reflect/value.go#L992-L994"><code>reflect.Value.Interface</code></a> 方法只能获得 <code>interface&#123;&#125;</code> 类型的变量，如果想要将其还原成最原始的状态还需要经过如下所示的显式类型转换：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">v <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
v<span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>从反射对象到接口值的过程就是从接口值到反射对象的镜面过程，两个过程都需要经历两次转换：</p>
<ul>
<li>从接口值到反射对象：<ul>
<li>从基本类型到接口类型的类型转换；</li>
<li>从接口类型到反射对象的转换；</li>
</ul>
</li>
<li>从反射对象到接口值：<ul>
<li>反射对象转换成接口类型；</li>
<li>通过显式类型转换变成原始类型；</li>
</ul>
</li>
</ul>
<p><img src="https://i.loli.net/2020/09/11/WUurJpdtQ9fTa7Z.png" alt="golang-bidirectional-reflection"><strong>接口和反射对象的双向转换</strong></p>
<p>当然不是所有的变量都需要类型转换这一过程。如果变量本身就是 <code>interface&#123;&#125;</code> 类型，那么它不需要类型转换，因为类型转换这一过程一般都是隐式的，所以我不太需要关心它，只有在我们需要将反射对象转换回基本类型时才需要显式的转换操作。</p>
<h3 id="第三法则"><a href="#第三法则" class="headerlink" title="第三法则"></a>第三法则</h3><p>Go 语言反射的最后一条法则是与值是否可以被更改有关，如果我们想要更新一个 <code>reflect.Value</code>，那么它持有的值一定是可以被更新的，假设我们有以下代码：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	i <span class="token operator">:=</span> <span class="token number">1</span>
	v <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
	v<span class="token punctuation">.</span><span class="token function">SetInt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

$ <span class="token keyword">go</span> run reflect<span class="token punctuation">.</span><span class="token keyword">go</span>
<span class="token builtin">panic</span><span class="token punctuation">:</span> reflect<span class="token punctuation">:</span> reflect<span class="token punctuation">.</span>flag<span class="token punctuation">.</span>mustBeAssignable using unaddressable value

goroutine <span class="token number">1</span> <span class="token punctuation">[</span>running<span class="token punctuation">]</span><span class="token punctuation">:</span>
reflect<span class="token punctuation">.</span>flag<span class="token punctuation">.</span><span class="token function">mustBeAssignableSlow</span><span class="token punctuation">(</span><span class="token number">0x82</span><span class="token punctuation">,</span> <span class="token number">0x1014c0</span><span class="token punctuation">)</span>
	<span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">/</span>src<span class="token operator">/</span>reflect<span class="token operator">/</span>value<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">247</span> <span class="token operator">+</span><span class="token number">0x180</span>
reflect<span class="token punctuation">.</span>flag<span class="token punctuation">.</span><span class="token function">mustBeAssignable</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
	<span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">/</span>src<span class="token operator">/</span>reflect<span class="token operator">/</span>value<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">234</span>
reflect<span class="token punctuation">.</span>Value<span class="token punctuation">.</span><span class="token function">SetInt</span><span class="token punctuation">(</span><span class="token number">0x100dc0</span><span class="token punctuation">,</span> <span class="token number">0x414020</span><span class="token punctuation">,</span> <span class="token number">0x82</span><span class="token punctuation">,</span> <span class="token number">0x1840</span><span class="token punctuation">,</span> <span class="token number">0xa</span><span class="token punctuation">,</span> <span class="token number">0x0</span><span class="token punctuation">)</span>
	<span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">/</span>src<span class="token operator">/</span>reflect<span class="token operator">/</span>value<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">1606</span> <span class="token operator">+</span><span class="token number">0x40</span>
main<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token operator">/</span>tmp<span class="token operator">/</span>sandbox590309925<span class="token operator">/</span>prog<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">11</span> <span class="token operator">+</span><span class="token number">0xe0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行上述代码会导致程序崩溃并报出 <code>reflect: reflect.flag.mustBeAssignable using unaddressable value</code> 错误，仔细思考一下就能够发现出错的原因，Go 语言的<a target="_blank" rel="noopener" href="http://draveness.me/golang-function-call">函数调用</a>都是传值的，所以我们得到的反射对象跟最开始的变量没有任何关系，所以直接对它修改会导致崩溃。</p>
<p>想要修改原有的变量只能通过如下的方法：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	i <span class="token operator">:=</span> <span class="token number">1</span>
	v <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>i<span class="token punctuation">)</span>
	v<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetInt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

$ <span class="token keyword">go</span> run reflect<span class="token punctuation">.</span><span class="token keyword">go</span>
<span class="token number">10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>调用 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/52c4488471ed52085a29e173226b3cbd2bf22b20/src/reflect/value.go#L2316-L2328"><code>reflect.ValueOf</code></a> 函数获取变量指针；</li>
<li>调用 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/52c4488471ed52085a29e173226b3cbd2bf22b20/src/reflect/value.go#L788-L821"><code>reflect.Value.Elem</code></a> 方法获取指针指向的变量；</li>
<li>调用 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/52c4488471ed52085a29e173226b3cbd2bf22b20/src/reflect/value.go#L1600-L1616"><code>reflect.Value.SetInt</code></a> 方法更新变量的值：</li>
</ol>
<p>由于 Go 语言的函数调用都是值传递的，所以我们只能先获取指针对应的 <code>reflect.Value</code>，再通过 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/52c4488471ed52085a29e173226b3cbd2bf22b20/src/reflect/value.go#L788-L821"><code>reflect.Value.Elem</code></a> 方法迂回的方式得到可以被设置的变量，我们通过如下所示的代码理解这个过程：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	i <span class="token operator">:=</span> <span class="token number">1</span>
	v <span class="token operator">:=</span> <span class="token operator">&amp;</span>i
	<span class="token operator">*</span>v <span class="token operator">=</span> <span class="token number">10</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果不能直接操作 <code>i</code> 变量修改其持有的值，我们就只能获取 <code>i</code> 变量所在地址并使用 <code>*v</code> 修改所在地址中存储的整数。</p>
<h2 id="类型和值"><a href="#类型和值" class="headerlink" title="类型和值"></a>类型和值</h2><p>Go 语言的 <code>interface&#123;&#125;</code> 类型在语言内部是通过 <code>emptyInterface</code> 这个结体来表示的，其中的 <code>rtype</code> 字段用于表示变量的类型，另一个 <code>word</code> 字段指向内部封装的数据：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> emptyInterface <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>
	typ  <span class="token operator">*</span>rtype
	word unsafe<span class="token punctuation">.</span>Pointer
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>用于获取变量类型的 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/52c4488471ed52085a29e173226b3cbd2bf22b20/src/reflect/type.go#L1365-L1368"><code>reflect.TypeOf</code></a> 函数将传入的变量隐式转换成 <code>emptyInterface</code> 类型并获取其中存储的类型信息 <code>rtype</code>：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">TypeOf</span><span class="token punctuation">(</span>i <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> Type <span class="token punctuation">&#123;</span>
	eface <span class="token operator">:=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>emptyInterface<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token function">toType</span><span class="token punctuation">(</span>eface<span class="token punctuation">.</span>typ<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">toType</span><span class="token punctuation">(</span>t <span class="token operator">*</span>rtype<span class="token punctuation">)</span> Type <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> t <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> t
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>rtype</code> 就是一个实现了 <code>Type</code> 接口的结构体，我们能在 <a target="_blank" rel="noopener" href="https://golang.org/pkg/reflect/"><code>reflect</code></a> 包中找到如下所示的 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/52c4488471ed52085a29e173226b3cbd2bf22b20/src/reflect/type.go#L752-L758"><code>reflect.rtype.String</code></a> 方法帮助我们获取当前类型的名称等信息：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>rtype<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
	s <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">nameOff</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>str<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> t<span class="token punctuation">.</span>tflag<span class="token operator">&amp;</span>tflagExtraStar <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> s
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/52c4488471ed52085a29e173226b3cbd2bf22b20/src/reflect/type.go#L1365-L1368"><code>reflect.TypeOf</code></a> 函数的实现原理其实并不复杂，它只是将一个 <code>interface&#123;&#125;</code> 变量转换成了内部的 <code>emptyInterface</code> 表示，然后从中获取相应的类型信息。</p>
<p>用于获取接口值 <code>Value</code> 的函数 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/52c4488471ed52085a29e173226b3cbd2bf22b20/src/reflect/value.go#L2316-L2328"><code>reflect.ValueOf</code></a> 实现也非常简单，在该函数中我们先调用了 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/4e8d27068df52eb372dc2ba7e929e47850934805/src/reflect/value.go#L2779-L2783"><code>reflect.escapes</code></a> 函数保证当前值逃逸到堆上，然后通过 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/4e8d27068df52eb372dc2ba7e929e47850934805/src/reflect/value.go#L140-L152"><code>reflect.unpackEface</code></a> 方法从接口中获取 <code>Value</code> 结构体：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">ValueOf</span><span class="token punctuation">(</span>i <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> Value <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> Value<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token function">escapes</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>

	<span class="token keyword">return</span> <span class="token function">unpackEface</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">unpackEface</span><span class="token punctuation">(</span>i <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> Value <span class="token punctuation">&#123;</span>
	e <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>emptyInterface<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
	t <span class="token operator">:=</span> e<span class="token punctuation">.</span>typ
	<span class="token keyword">if</span> t <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> Value<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	f <span class="token operator">:=</span> <span class="token function">flag</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token function">ifaceIndir</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		f <span class="token operator">|=</span> flagIndir
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> Value<span class="token punctuation">&#123;</span>t<span class="token punctuation">,</span> e<span class="token punctuation">.</span>word<span class="token punctuation">,</span> f<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/4e8d27068df52eb372dc2ba7e929e47850934805/src/reflect/value.go#L140-L152"><code>reflect.unpackEface</code></a> 函数会将传入的接口转换成 <code>emptyInterface</code> 结构体，然后将具体类型和指针包装成 <code>Value</code> 结构体并返回。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/52c4488471ed52085a29e173226b3cbd2bf22b20/src/reflect/type.go#L1365-L1368"><code>reflect.TypeOf</code></a> 和 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/52c4488471ed52085a29e173226b3cbd2bf22b20/src/reflect/value.go#L2316-L2328"><code>reflect.ValueOf</code></a> 函数的实现都很简单。我们已经分析了这两个函数的实现，现在需要了解编译器在调用函数之前做了哪些工作：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"reflect"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	i <span class="token operator">:=</span> <span class="token number">20</span>
	<span class="token boolean">_</span> <span class="token operator">=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

$ <span class="token keyword">go</span> build <span class="token operator">-</span>gcflags<span class="token operator">=</span><span class="token string">"-S -N"</span> main<span class="token punctuation">.</span><span class="token keyword">go</span>
<span class="token operator">...</span>
MOVQ	$<span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">.</span><span class="token punctuation">.</span>autotmp_20<span class="token operator">+</span><span class="token function">56</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span> <span class="token comment">// autotmp = 20</span>
LEAQ	<span class="token keyword">type</span><span class="token punctuation">.</span><span class="token function">int</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> AX           <span class="token comment">// AX = type.int(SB)</span>
MOVQ	AX<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">.</span><span class="token punctuation">.</span>autotmp_19<span class="token operator">+</span><span class="token function">280</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span> <span class="token comment">// autotmp_19+280(SP) = type.int(SB)</span>
LEAQ	<span class="token string">""</span><span class="token punctuation">.</span><span class="token punctuation">.</span>autotmp_20<span class="token operator">+</span><span class="token function">56</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span><span class="token punctuation">,</span> CX  <span class="token comment">// CX = 20</span>
MOVQ	CX<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">.</span><span class="token punctuation">.</span>autotmp_19<span class="token operator">+</span><span class="token function">288</span><span class="token punctuation">(</span>SP<span class="token punctuation">)</span> <span class="token comment">// autotmp_19+288(SP) = 20</span>
<span class="token operator">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从上面这段截取的汇编语言，我们发现在函数调用之前已经发生了类型转换，上述指令将 <code>int</code> 类型的变量转换成了占用 16 字节 <code>autotmp_19+280(SP) ~ autotmp_19+288(SP)</code> 的接口，两个 <code>LEAQ</code> 指令分别获取了类型的指针 <code>type.int(SB)</code> 以及变量 <code>i</code> 所在的地址。</p>
<p>当我们想要将一个变量转换成反射对象时，Go 语言会在编译期间完成类型转换的工作，将变量的类型和值转换成了 <code>interface&#123;&#125;</code> 并等待运行期间使用 <a target="_blank" rel="noopener" href="https://golang.org/pkg/reflect/"><code>reflect</code></a> 包获取接口中存储的信息。</p>
<h2 id="更新变量"><a href="#更新变量" class="headerlink" title="更新变量"></a>更新变量</h2><p>当我们想要更新一个 <code>reflect.Value</code>，就需要调用 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/4e8d27068df52eb372dc2ba7e929e47850934805/src/reflect/value.go#L1525-L1538"><code>reflect.Value.Set</code></a> 方法更新反射对象，该方法会调用 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/4e8d27068df52eb372dc2ba7e929e47850934805/src/reflect/value.go#L232-L236"><code>reflect.flag.mustBeAssignable</code></a> 和 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/4e8d27068df52eb372dc2ba7e929e47850934805/src/reflect/value.go#L214-L218"><code>reflect.flag.mustBeExported</code></a> 分别检查当前反射对象是否是可以被设置的以及字段是否是对外公开的：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>v Value<span class="token punctuation">)</span> <span class="token function">Set</span><span class="token punctuation">(</span>x Value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	v<span class="token punctuation">.</span><span class="token function">mustBeAssignable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	x<span class="token punctuation">.</span><span class="token function">mustBeExported</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> target unsafe<span class="token punctuation">.</span>Pointer
	<span class="token keyword">if</span> v<span class="token punctuation">.</span><span class="token function">kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Interface <span class="token punctuation">&#123;</span>
		target <span class="token operator">=</span> v<span class="token punctuation">.</span>ptr
	<span class="token punctuation">&#125;</span>
	x <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token function">assignTo</span><span class="token punctuation">(</span><span class="token string">"reflect.Set"</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span>typ<span class="token punctuation">,</span> target<span class="token punctuation">)</span>
	<span class="token function">typedmemmove</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>typ<span class="token punctuation">,</span> v<span class="token punctuation">.</span>ptr<span class="token punctuation">,</span> x<span class="token punctuation">.</span>ptr<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/4e8d27068df52eb372dc2ba7e929e47850934805/src/reflect/value.go#L1525-L1538"><code>reflect.Value.Set</code></a> 方法会调用 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/4e8d27068df52eb372dc2ba7e929e47850934805/src/reflect/value.go#L2370-L2404"><code>reflect.Value.assignTo</code></a> 并返回一个新的反射对象，这个返回的反射对象指针就会直接覆盖原始的反射变量。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>v Value<span class="token punctuation">)</span> <span class="token function">assignTo</span><span class="token punctuation">(</span>context <span class="token builtin">string</span><span class="token punctuation">,</span> dst <span class="token operator">*</span>rtype<span class="token punctuation">,</span> target unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> Value <span class="token punctuation">&#123;</span>
	<span class="token operator">...</span>
	<span class="token keyword">switch</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">case</span> <span class="token function">directlyAssignable</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> v<span class="token punctuation">.</span>typ<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token operator">...</span>
		<span class="token keyword">return</span> Value<span class="token punctuation">&#123;</span>dst<span class="token punctuation">,</span> v<span class="token punctuation">.</span>ptr<span class="token punctuation">,</span> fl<span class="token punctuation">&#125;</span>
	<span class="token keyword">case</span> <span class="token function">implements</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> v<span class="token punctuation">.</span>typ<span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">if</span> v<span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Interface <span class="token operator">&amp;&amp;</span> v<span class="token punctuation">.</span><span class="token function">IsNil</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> Value<span class="token punctuation">&#123;</span>dst<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token function">flag</span><span class="token punctuation">(</span>Interface<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
		x <span class="token operator">:=</span> <span class="token function">valueInterface</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> dst<span class="token punctuation">.</span><span class="token function">NumMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
			<span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">=</span> x
		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
			<span class="token function">ifaceE2I</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> x<span class="token punctuation">,</span> target<span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> Value<span class="token punctuation">&#123;</span>dst<span class="token punctuation">,</span> target<span class="token punctuation">,</span> flagIndir <span class="token operator">|</span> <span class="token function">flag</span><span class="token punctuation">(</span>Interface<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">panic</span><span class="token punctuation">(</span>context <span class="token operator">+</span> <span class="token string">": value of type "</span> <span class="token operator">+</span> v<span class="token punctuation">.</span>typ<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" is not assignable to type "</span> <span class="token operator">+</span> dst<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/4e8d27068df52eb372dc2ba7e929e47850934805/src/reflect/value.go#L2370-L2404"><code>reflect.Value.assignTo</code></a> 会根据当前和被设置的反射对象类型创建一个新的 <code>Value</code> 结构体：</p>
<ul>
<li>如果两个反射对象的类型是可以被直接替换，就会直接将目标反射对象返回；</li>
<li>如果当前反射对象是接口并且目标对象实现了接口，就会将目标对象简单包装成接口值；</li>
</ul>
<p>在变量更新的过程中，<a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/4e8d27068df52eb372dc2ba7e929e47850934805/src/reflect/value.go#L2370-L2404"><code>reflect.Value.assignTo</code></a> 返回的 <code>reflect.Value</code> 中的指针会覆盖当前反射对象中的指针实现变量的更新。</p>
<h2 id="实现协议"><a href="#实现协议" class="headerlink" title="实现协议"></a>实现协议</h2><p><a target="_blank" rel="noopener" href="https://golang.org/pkg/reflect/"><code>reflect</code></a> 包还为我们提供了 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/4e8d27068df52eb372dc2ba7e929e47850934805/src/reflect/type.go#L1430-L1438"><code>reflect.rtypes.Implements</code></a> 方法可以用于判断某些类型是否遵循特定的接口。在 Go 语言中获取结构体的反射类型 <code>reflect.Type</code> 还是比较容易的，但是想要获得接口的类型就需要通过以下方式：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">&lt;</span><span class="token keyword">interface</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们通过一个例子在介绍如何判断一个类型是否实现了某个接口。假设我们需要判断如下代码中的 <code>CustomError</code> 是否实现了 Go 语言标准库中的 <code>error</code> 接口：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> CustomError <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>CustomError<span class="token punctuation">)</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">return</span> <span class="token string">""</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	typeOfError <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	customErrorPtr <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>CustomError<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
	customError <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>CustomError<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>customErrorPtr<span class="token punctuation">.</span><span class="token function">Implements</span><span class="token punctuation">(</span>typeOfError<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// #=> true</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>customError<span class="token punctuation">.</span><span class="token function">Implements</span><span class="token punctuation">(</span>typeOfError<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// #=> false</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上述代码的运行结果正如我们在<a target="_blank" rel="noopener" href="https://draveness.me/golang/docs/part2-foundation/ch04-basic/golang-interface/">接口</a>一节中介绍的：</p>
<ul>
<li><code>CustomError</code> 类型并没有实现 <code>error</code> 接口；</li>
<li><code>*CustomError</code> 指针类型实现了 <code>error</code> 接口；</li>
</ul>
<p>抛开上述的执行结果不谈，我们来分析一下 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/4e8d27068df52eb372dc2ba7e929e47850934805/src/reflect/type.go#L1430-L1438"><code>reflect.rtypes.Implements</code></a> 方法的工作原理：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>rtype<span class="token punctuation">)</span> <span class="token function">Implements</span><span class="token punctuation">(</span>u Type<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">if</span> u <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"reflect: nil type passed to Type.Implements"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> u<span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> Interface <span class="token punctuation">&#123;</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"reflect: non-interface type passed to Type.Implements"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token function">implements</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>rtype<span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/4e8d27068df52eb372dc2ba7e929e47850934805/src/reflect/type.go#L1430-L1438"><code>reflect.rtypes.Implements</code></a> 方法会检查传入的类型是不是接口，如果不是接口或者是空值就会直接 panic 中止当前程序。在参数没有问题的情况下，上述方法会调用私有函数 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/4e8d27068df52eb372dc2ba7e929e47850934805/src/reflect/type.go#L1461-L1543"><code>reflect.implements</code></a> 判断类型之间是否有实现关系：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">implements</span><span class="token punctuation">(</span>T<span class="token punctuation">,</span> V <span class="token operator">*</span>rtype<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">&#123;</span>
	t <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>interfaceType<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>methods<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span>
	<span class="token punctuation">&#125;</span>
	<span class="token operator">...</span>
	v <span class="token operator">:=</span> V<span class="token punctuation">.</span><span class="token function">uncommon</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	i <span class="token operator">:=</span> <span class="token number">0</span>
	vmethods <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token function">methods</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> j <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token function">int</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>mcount<span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		tm <span class="token operator">:=</span> <span class="token operator">&amp;</span>t<span class="token punctuation">.</span>methods<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
		tmName <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">nameOff</span><span class="token punctuation">(</span>tm<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
		vm <span class="token operator">:=</span> vmethods<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
		vmName <span class="token operator">:=</span> V<span class="token punctuation">.</span><span class="token function">nameOff</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
		<span class="token keyword">if</span> vmName<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> tmName<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> V<span class="token punctuation">.</span><span class="token function">typeOff</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>mtyp<span class="token punctuation">)</span> <span class="token operator">==</span> t<span class="token punctuation">.</span><span class="token function">typeOff</span><span class="token punctuation">(</span>tm<span class="token punctuation">.</span>typ<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> i<span class="token operator">++</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token function">len</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>methods<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span> <span class="token boolean">true</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果接口中不包含任何方法，就意味着这是一个空的接口，任意类型都自动实现该接口，这时就会直接返回 <code>true</code>。</p>
<p><img src="https://i.loli.net/2020/09/11/kUQRuvsaTMynx5q.png" alt="golang-type-implements-interface"></p>
<p><strong>类型实现接口</strong></p>
<p>在其他情况下，由于方法都是按照字母序存储的，<a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/4e8d27068df52eb372dc2ba7e929e47850934805/src/reflect/type.go#L1461-L1543"><code>reflect.implements</code></a> 会维护两个用于遍历接口和类型方法的索引 <code>i</code> 和 <code>j</code> 判断类型是否实现了接口，因为最多只会进行 <code>n</code> 次比较（类型的方法数量），所以整个过程的时间复杂度是 <code>O(n)</code>。</p>
<h2 id="方法调用"><a href="#方法调用" class="headerlink" title="方法调用"></a>方法调用</h2><p>作为一门静态语言，如果我们想要通过 <a target="_blank" rel="noopener" href="https://golang.org/pkg/reflect/"><code>reflect</code></a> 包利用反射在运行期间执行方法不是一件容易的事情，下面的十几行代码就使用反射来执行 <code>Add(0, 1)</code> 函数：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">Add</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token punctuation">&#125;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	v <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>Add<span class="token punctuation">)</span>
	<span class="token keyword">if</span> v<span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> reflect<span class="token punctuation">.</span>Func <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	t <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token function">Type</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	argv <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>reflect<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">NumIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> argv <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token function">In</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> reflect<span class="token punctuation">.</span>Int <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">&#125;</span>
		argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	result <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">||</span> result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> reflect<span class="token punctuation">.</span>Int <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">&#125;</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// #=> 1</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>通过 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/52c4488471ed52085a29e173226b3cbd2bf22b20/src/reflect/value.go#L2316-L2328"><code>reflect.ValueOf</code></a> 获取函数 <code>Add</code> 对应的反射对象；</li>
<li>根据反射对象 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/4e8d27068df52eb372dc2ba7e929e47850934805/src/reflect/type.go#L979-L985"><code>reflect.rtype.NumIn</code></a> 方法返回的参数个数创建 <code>argv</code> 数组；</li>
<li>多次调用 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/52c4488471ed52085a29e173226b3cbd2bf22b20/src/reflect/value.go#L2316-L2328"><code>reflect.ValueOf</code></a> 函数逐一设置 <code>argv</code> 数组中的各个参数；</li>
<li>调用反射对象 <code>Add</code> 的 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/4e8d27068df52eb372dc2ba7e929e47850934805/src/reflect/value.go#L318-L322"><code>reflect.Value.Call</code></a> 方法并传入参数列表；</li>
<li>获取返回值数组、验证数组的长度以及类型并打印其中的数据；</li>
</ol>
<p>使用反射来调用方法非常复杂，原本只需要一行代码就能完成的工作，现在需要十几行代码才能完成，但这也是在静态语言中使用动态特性需要付出的成本。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>v Value<span class="token punctuation">)</span> <span class="token function">Call</span><span class="token punctuation">(</span>in <span class="token punctuation">[</span><span class="token punctuation">]</span>Value<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Value <span class="token punctuation">&#123;</span>
	v<span class="token punctuation">.</span><span class="token function">mustBe</span><span class="token punctuation">(</span>Func<span class="token punctuation">)</span>
	v<span class="token punctuation">.</span><span class="token function">mustBeExported</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> v<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"Call"</span><span class="token punctuation">,</span> in<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/4e8d27068df52eb372dc2ba7e929e47850934805/src/reflect/value.go#L318-L322"><code>reflect.Value.Call</code></a> 方法是运行时调用方法的入口，它通过两个 <code>MustBe</code> 开头的方法确定了当前反射对象的类型是函数以及可见性，随后调用 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/4e8d27068df52eb372dc2ba7e929e47850934805/src/reflect/value.go#L339-L501"><code>reflect.Value.call</code></a> 完成方法调用，这个私有方法的执行过程会分成以下的几个部分：</p>
<ol>
<li>检查输入参数以及类型的合法性；</li>
<li>将传入的 <code>reflect.Value</code> 参数数组设置到栈上；</li>
<li>通过函数指针和输入参数调用函数；</li>
<li>从栈上获取函数的返回值；</li>
</ol>
<p>我们将按照上面的顺序分析使用 <a target="_blank" rel="noopener" href="https://golang.org/pkg/reflect/"><code>reflect</code></a> 进行函数调用的几个过程。</p>
<h3 id="参数检查"><a href="#参数检查" class="headerlink" title="参数检查"></a>参数检查</h3><p>参数检查是通过反射调用方法的第一步，在参数检查期间我们会从反射对象中取出当前的函数指针 <code>unsafe.Pointer</code>，如果该函数指针是方法，那么我们就会通过 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/4e8d27068df52eb372dc2ba7e929e47850934805/src/reflect/value.go#L612-L645"><code>reflect.methodReceiver</code></a> 函数获取方法的接受者和函数指针。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>v Value<span class="token punctuation">)</span> <span class="token function">call</span><span class="token punctuation">(</span>op <span class="token builtin">string</span><span class="token punctuation">,</span> in <span class="token punctuation">[</span><span class="token punctuation">]</span>Value<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Value <span class="token punctuation">&#123;</span>
	t <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>funcType<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>typ<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token operator">...</span>
	<span class="token keyword">if</span> v<span class="token punctuation">.</span>flag<span class="token operator">&amp;</span>flagMethod <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		rcvr <span class="token operator">=</span> v
		rcvrtype<span class="token punctuation">,</span> t<span class="token punctuation">,</span> fn <span class="token operator">=</span> <span class="token function">methodReceiver</span><span class="token punctuation">(</span>op<span class="token punctuation">,</span> v<span class="token punctuation">,</span> <span class="token function">int</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>flag<span class="token punctuation">)</span><span class="token operator">>></span>flagMethodShift<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token operator">...</span>
	<span class="token punctuation">&#125;</span>
	n <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">NumIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span> <span class="token operator">&lt;</span> n <span class="token punctuation">&#123;</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"reflect: Call with too few input arguments"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span> <span class="token operator">></span> n <span class="token punctuation">&#123;</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"reflect: Call with too many input arguments"</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span> xt<span class="token punctuation">,</span> targ <span class="token operator">:=</span> in<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">In</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>xt<span class="token punctuation">.</span><span class="token function">AssignableTo</span><span class="token punctuation">(</span>targ<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"reflect: "</span> <span class="token operator">+</span> op <span class="token operator">+</span> <span class="token string">" using "</span> <span class="token operator">+</span> xt<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" as type "</span> <span class="token operator">+</span> targ<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在上述方法中，上述方法还会检查传入参数的个数以及参数的类型与函数签名中的类型是否可以匹配，任何参数的不匹配都会导致整个程序的崩溃中止。</p>
<h3 id="准备参数"><a href="#准备参数" class="headerlink" title="准备参数"></a>准备参数</h3><p>当我们已经对当前方法的参数完成验证之后，就会进入函数调用的下一个阶段，为函数调用准备参数，在前面的章节<a target="_blank" rel="noopener" href="https://draveness.me/golang/basic/golang-function-call.html">函数调用</a>中我们已经介绍过 Go 语言的函数调用惯例，函数或者方法在调用时，所有的参数都会被依次放置到栈上。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">nout <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">NumOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
frametype<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> retOffset<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> framePool <span class="token operator">:=</span> <span class="token function">funcLayout</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> rcvrtype<span class="token punctuation">)</span>

<span class="token keyword">var</span> args unsafe<span class="token punctuation">.</span>Pointer
<span class="token keyword">if</span> nout <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
	args <span class="token operator">=</span> framePool<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
	args <span class="token operator">=</span> <span class="token function">unsafe_New</span><span class="token punctuation">(</span>frametype<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
off <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> rcvrtype <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
	<span class="token function">storeRcvr</span><span class="token punctuation">(</span>rcvr<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
	off <span class="token operator">=</span> ptrSize
<span class="token punctuation">&#125;</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> in <span class="token punctuation">&#123;</span>
	targ <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">In</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>rtype<span class="token punctuation">)</span>
	a <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>targ<span class="token punctuation">.</span>align<span class="token punctuation">)</span>
	off <span class="token operator">=</span> <span class="token punctuation">(</span>off <span class="token operator">+</span> a <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;^</span> <span class="token punctuation">(</span>a <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
	n <span class="token operator">:=</span> targ<span class="token punctuation">.</span>size
	<span class="token operator">...</span>
	addr <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> off<span class="token punctuation">,</span> <span class="token string">"n > 0"</span><span class="token punctuation">)</span>
	v <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">assignTo</span><span class="token punctuation">(</span><span class="token string">"reflect.Value.Call"</span><span class="token punctuation">,</span> targ<span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span> <span class="token operator">=</span> v<span class="token punctuation">.</span>ptr
	off <span class="token operator">+=</span> n
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li><p>通过 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/4e8d27068df52eb372dc2ba7e929e47850934805/src/reflect/type.go#L2975-L3048"><code>reflect.funcLayout</code></a> 函数计算当前函数需要的参数和返回值的栈布局，也就是每一个参数和返回值所占的空间大小；</p>
</li>
<li><p>如果当前函数有返回值，需要为当前函数的参数和返回值分配一片内存空间 <code>args</code>；</p>
</li>
<li><p>如果当前函数是方法，需要向将方法的接受者拷贝到 <code>args</code> 内存中；</p>
</li>
<li><p>将所有函数的参数按照顺序依次拷贝到对应</p>
</li>
</ol>
   <pre class="line-numbers language-none"><code class="language-none">args<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>   内存中</p>
<ol>
<li>使用 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/4e8d27068df52eb372dc2ba7e929e47850934805/src/reflect/type.go#L2975-L3048"><code>reflect.funcLayout</code></a> 返回的参数计算参数在内存中的位置；</li>
<li>将参数拷贝到内存空间中；</li>
</ol>
<p>准备参数的过程是计算各个参数和返回值占用的内存空间并将所有的参数都拷贝内存空间对应的位置的过程，该过程会考虑函数和方法、返回值数量以及参数类型带来的差异。</p>
<h3 id="调用函数"><a href="#调用函数" class="headerlink" title="调用函数"></a>调用函数</h3><p>准备好调用函数需要的全部参数之后，就会通过以下的代码执行函数指针了。我们会向该函数传入栈类型、函数指针、参数和返回值的内存空间、栈的大小以及返回值的偏移量：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token function">call</span><span class="token punctuation">(</span>frametype<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> args<span class="token punctuation">,</span> <span class="token function">uint32</span><span class="token punctuation">(</span>frametype<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uint32</span><span class="token punctuation">(</span>retOffset<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>上述函数实际上并不存在，它会在编译期间被链接到 <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/a38a917aee626a9b9d5ce2b93964f586bf759ea0/src/runtime/asm_386.s#L489-L526"><code>runtime.reflectcall</code></a> 这个用汇编实现的函数上，我们在这里不会分析该函数的具体实现，感兴趣的读者可以自行了解其实现原理。</p>
<h3 id="处理返回值"><a href="#处理返回值" class="headerlink" title="处理返回值"></a>处理返回值</h3><p>当函数调用结束之后，就会开始处理函数的返回值：</p>
<ul>
<li>如果函数没有任何返回值，会直接清空 <code>args</code> 中的全部内容来释放内存空间；</li>
<li>如果当前函数有返回值；<ol>
<li>将 <code>args</code> 中与输入参数有关的内存空间清空；</li>
<li>创建一个 <code>nout</code> 长度的切片用于保存由反射对象构成的返回值数组；</li>
<li>从函数对象中获取返回值的类型和内存大小，将 <code>args</code> 内存中的数据转换成 <code>reflect.Value</code> 类型并存储到切片中；</li>
</ol>
</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">	<span class="token keyword">var</span> ret <span class="token punctuation">[</span><span class="token punctuation">]</span>Value
	<span class="token keyword">if</span> nout <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		<span class="token function">typedmemclr</span><span class="token punctuation">(</span>frametype<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
		framePool<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token function">typedmemclrpartial</span><span class="token punctuation">(</span>frametype<span class="token punctuation">,</span> args<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> retOffset<span class="token punctuation">)</span>
		ret <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Value<span class="token punctuation">,</span> nout<span class="token punctuation">)</span>
		off <span class="token operator">=</span> retOffset
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nout<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>
			tv <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">Out</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
			a <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>tv<span class="token punctuation">.</span><span class="token function">Align</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			off <span class="token operator">=</span> <span class="token punctuation">(</span>off <span class="token operator">+</span> a <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;^</span> <span class="token punctuation">(</span>a <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> tv<span class="token punctuation">.</span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
				fl <span class="token operator">:=</span> flagIndir <span class="token operator">|</span> <span class="token function">flag</span><span class="token punctuation">(</span>tv<span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				ret<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> Value<span class="token punctuation">&#123;</span>tv<span class="token punctuation">.</span><span class="token function">common</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">add</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> off<span class="token punctuation">,</span> <span class="token string">"tv.Size() != 0"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fl<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
				ret<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Zero</span><span class="token punctuation">(</span>tv<span class="token punctuation">)</span>
			<span class="token punctuation">&#125;</span>
			off <span class="token operator">+=</span> tv<span class="token punctuation">.</span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	
	<span class="token keyword">return</span> ret
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由 <code>reflect.Value</code> 构成的 <code>ret</code> 数组会被返回到上层，到这里为止使用反射实现函数调用的过程就结束了。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>Go 语言的 <a target="_blank" rel="noopener" href="https://golang.org/pkg/reflect/"><code>reflect</code></a> 包为我们提供的多种能力，包括如何使用反射来动态修改变量、判断类型是否实现了某些接口以及动态调用方法等功能，通过对反射包中方法原理的分析能帮助我们理解之前看起来比较怪异、令人困惑的现象。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://blog.golang.org/laws-of-reflection">The Laws of Reflection</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/golang/go/commit/3d1699ea787f38be6088f9a098d6e08dafca9387">runtime: new itab lookup table</a></li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/golang/go/issues/20505">runtime: need a better itab table</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://golang.org/pkg/reflect/">Package reflect</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.golang.org/laws-of-reflection">The Laws of Reflection</a> </p>
</li>
</ul>

            </div>
            <!-- Post Comments -->
            
        </div>
        <!-- Copyright 版权 start -->
        <div id="copyright">
    <ul>
        <li>&copy;Powered By <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/" style="border-bottom: none;">hexo</a></li>
        <li>Theme: <a target="_blank" rel="noopener" href="http://miccall.tech " style="border-bottom: none;">miccall</a></li>
        <!-- <li><a href="">鄂ICP备2020015912号-1</a></li> -->
    </ul>
    
    <span id="busuanzi_container_site_pv"> 2020 </span>
    
</div>
    </div>
</body>





</html>