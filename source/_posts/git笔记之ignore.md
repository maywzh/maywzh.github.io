---
title: git笔记之ignore
categories: 编程工具
date: 2016-08-29 13:34:15
tags: 
  - git

---

在push到远程仓库中，往往要忽略中间文件和开发环境配置文件等文件的提交，这时就要设置相应的忽略规则，来自动忽略这些文件。

## 原则

**Git忽略文件的原则**

- 忽略操作系统自动生成的文件，例如macOS中的`.DS_Store`
- 忽略编译生成的中间文件、可执行文件等，如果一个文件是通过另一个文件自动生成的，那么就没必要放进版本库，比如Java编译产生的`.class`文件
-  忽略带有敏感信息的配置文件，比如存放口令的配置文件



## 方式

**有三种方法可以实现忽略Git中不想提交的文件**：

1. 在项目中定义.gitignore文件
   在项目根目录下定义.gitignore 文件，它往往要提交到公有仓库中，为该项目下的所有开发者都预设定义好的忽略规则。.gitingore 文件每一行指定一个忽略规则。如：

```ignore
`*.log``*.temp``/vendor`
```

2. 在项目的设置中临时指定排除文件
   这种方式只是临时指定该项目的行为，需要编辑当前项目下的 `.git/info/exclude`文件，然后将需要忽略提交的文件写入其中。这种方式指定的忽略文件的根目录是项目根目录。

3. 定义全局的 .gitignore 文件
   除了可以在项目中定义 `.gitignore` 文件外，还可以设置全局的git `.gitignore`文件来管理所有由git版本控制项目的行为。这种方式是定义个人开发机的全局环境，不在项目成员中共享。这种方式也需要创建相应的 .gitignore 文件，可以放在任意位置。然后在使用以下命令配置：

```bash
`# git config --global core.excludesfile ~/.gitignore`
```



## 语法

### 匹配语法

1. 空格不匹配任意文件，可作为分隔符，可用反斜杠转义
2. `#`开头的行代表注释，git忽略，可以使用反斜杠进行转义
3. `.gitignore`使用标准的glob模式匹配。[glob模式](https://en.wikipedia.org/wiki/Glob_(programming))往往用于在类UNIX系统中匹配文件路径。
4. 斜杠`/`开头表示目录，`/`结束的模式只匹配文件夹和该文件夹路径下的内容，`/`开始的模式匹配项目根目录
5. 星号`*`通配多个字符，问号`?`通配单个字符， 使用两个星号`**`表示匹配任意中间目录
6. 方括号`[]`包含单个字符的匹配列表，即匹配任何一个列在方括号中的字符。
7. 叹号`!`表示不忽略(跟踪)匹配到的文件或目录，即要忽略指定模式以外的文件或目录，可以在模式前加上惊叹号`（!）`取反。**如果文件的父目录已经被前面的规则排除掉了，那么对这个文件用"!"规则是不起作用的**。也就是说"!"开头的模式表示否定，该文件将会再次被包含，如果排除了该文件的父级目录，则使用"!"也不会再次被包含。可以使用反斜杠进行转义。
8. .git对于.ignore配置文件是按行从上到下进行规则匹配的，意味着如果前面的规则匹配的范围更大，则后面的规则将不会生效！



### 优先级
在 .gitingore 文件中，每一行指定一个忽略规则，Git检查忽略规则的时候有多个来源，它的优先级如下（由高到低）：

1. 从命令行中读取可用的忽略规则
2. 当前目录定义的规则
3. 父级目录定义的规则，依次递推
4. $GIT_DIR/info/exclude 文件中定义的规则
5. core.excludesfile中定义的全局规则



例：

```
`#               表示此为注释,将被Git忽略``*.a             表示忽略所有 .a 结尾的文件``!lib.a          表示但lib.a除外``/TODO`           `表示仅仅忽略项目根目录下的 TODO 文件，不包括 subdir``/TODO``build/          表示忽略 build/目录下的所有文件，过滤整个build文件夹；``doc/*.txt       表示会忽略doc``/notes``.txt但不包括 doc``/server/arch``.txt` `bin/:           表示忽略当前路径下的bin文件夹，该文件夹下的所有内容都会被忽略，不忽略 bin 文件``/bin``:           表示忽略根目录下的bin文件``/*.c:           表示忽略``cat``.c，不忽略 build``/cat``.c``debug/*.obj:    表示忽略debug``/io``.obj，不忽略 debug``/common/io``.obj和tools``/debug/io``.obj``**``/foo``:         表示忽略``/foo``,a``/foo``,a``/b/foo``等``a/**``/b``:         表示忽略a``/b``, a``/x/b``,a``/x/y/b``等``!``/bin/run``.sh    表示不忽略bin目录下的run.sh文件``*.log:          表示忽略所有 .log 文件``config.php:     表示忽略当前路径的 config.php 文件` `/mtk/`           `表示过滤整个文件夹``*.zip           表示过滤所有.zip文件``/mtk/do``.c       表示过滤某个具体文件` `被过滤掉的文件就不会出现在git仓库中（gitlab或github）了，当然本地库中还有，只是push的时候不会上传。` `需要注意的是，gitignore还可以指定要将哪些文件添加到版本管理中，如下：``!*.zip``!``/mtk/one``.txt` `唯一的区别就是规则开头多了一个感叹号，Git会将满足这类规则的文件添加到版本管理中。为什么要有两种规则呢？``想象一个场景：假如我们只需要管理``/mtk/``目录中的one.txt文件，这个目录中的其他文件都不需要管理，那么.gitignore规则应写为：：``/mtk/``*``!``/mtk/one``.txt` `假设我们只有过滤规则，而没有添加规则，那么我们就需要把``/mtk/``目录下除了one.txt以外的所有文件都写出来！``注意上面的``/mtk/``*不能写为``/mtk/``，否则父目录被前面的规则排除掉了，one.txt文件虽然加了!过滤规则，也不会生效！` `----------------------------------------------------------------------------------``还有一些规则如下：``fd1/*``说明：忽略目录 fd1 下的全部内容；注意，不管是根目录下的 ``/fd1/` `目录，还是某个子目录 ``/child/fd1/` `目录，都会被忽略；` `/fd1/``*``说明：忽略根目录下的 ``/fd1/` `目录的全部内容；` `/*``!.gitignore``!``/fw/` `/fw/``*``!``/fw/bin/``!``/fw/sf/``说明：忽略全部内容，但是不忽略 .gitignore 文件、根目录下的 ``/fw/bin/` `和 ``/fw/sf/` `目录；注意要先对bin/的父目录使用!规则，使其不被排除。`
```

⚠️
如果如果在版本库中写`.gitignore`文件之前就已经提交了要忽略的文件，那么Git仍然会对这些文件进行版本管理。例如已经commit了`1.a`这个文件到版本库，再写入`1.a`这条忽略规则到`.gitignore`文件，那么这条规则就失效了。对`1.a`文件的修改仍然会被版本控制。这种情况的解决方式可以参看[git rm删除版本控制](https://maywzh.com/git笔记之rm/)。



## 查看规则

我们可以用`git check-ignore`命令检查忽略规则：

```bash
`$ git check-ignore -``v` `HelloWorld.class``.gitignore:1:*.class    HelloWorld.class`
```

可以看到`./bin/root-bin.a`匹配到了我们的第二行`/bin`的忽略规则，所以文件被忽略了。

## 删除本地缓存

有的时候已经在.gitignore中标明忽略的文件，但git status中该文件依旧处于tracted状态，这是因为在git忽略目录中，新建的文件会有缓存，如果某文件已经被纳入版本管理，那么再在.gitignore中声明也是无效的，此时需要删除本地缓存，这样不会直接删除文件。如果去掉`--cached`选项则是直接删除对应文件。

```bash
`.gitignore中已经标明忽略的文件目录下的文件，git push的时候还会出现在push的目录中，或者用git status查看状态，想要忽略的文件还是显示被追踪状态。``原因是因为在git忽略目录中，新建的文件在git中会有缓存，如果某些文件已经被纳入了版本管理中，就算是在.gitignore中已经声明了忽略路径也是不起作用的，``这时候我们就应该先把本地缓存删除，然后再进行git的push，这样就不会出现忽略的文件了。` `解决方法:git清除本地缓存（改变成未track状态），然后再提交:``[root@kevin ~]``# git rm -r --cached .``[root@kevin ~]``# git add .``[root@kevin ~]``# git commit -m 'update .gitignore'` `需要特别注意的是：``1）.gitignore只能忽略那些原来没有被track的文件，如果某些文件已经被纳入了版本管理中，则修改.gitignore是无效的。``2）想要.gitignore起作用，必须要在这些文件不在暂存区中才可以，.gitignore文件只是忽略没有被staged(cached)文件，``   ``对于已经被staged文件，加入ignore文件时一定要先从staged移除，才可以忽略。 `
```



## 远程仓库中删除版本控制

有的时候想移除远程仓库中的某些文件的版本控制，但依旧在本地保留该文件。这时候不可以直接使用`git rm directory`，这样会删除本地仓库的文件。可以使用`git rm -r –cached directory`来删除本地缓存，然后进行commit 和push，这样会发现远程仓库中的不必要文件就被删除了，以后可以直接使用`git add -A`来添加修改的内容，上传的文件就会受到.gitignore文件的内容约束。

```bash
$ git rm -r --cached 1.a
$ git add -A
$ git commit -m "update .gitignore"
$ git push origin
```

